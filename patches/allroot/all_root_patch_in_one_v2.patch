Index: framework/base/src/org/ofbiz/base/component/ComponentConfig.java
===================================================================
--- framework/base/src/org/ofbiz/base/component/ComponentConfig.java	(revision 1494668)
+++ framework/base/src/org/ofbiz/base/component/ComponentConfig.java	(working copy)
@@ -24,6 +24,8 @@
 import java.net.URL;
 import java.util.Collection;
 import java.util.Comparator;
+import java.util.LinkedHashMap;
+import java.util.LinkedList;
 import java.util.List;
 import java.util.Map;
 import java.util.TreeMap;
@@ -37,7 +39,9 @@
 import org.ofbiz.base.container.ContainerException;
 import org.ofbiz.base.location.FlexibleLocation;
 import org.ofbiz.base.util.Debug;
+import org.ofbiz.base.util.FileUtil;
 import org.ofbiz.base.util.KeyStoreUtil;
+import org.ofbiz.base.util.UtilProperties;
 import org.ofbiz.base.util.UtilURL;
 import org.ofbiz.base.util.UtilValidate;
 import org.ofbiz.base.util.UtilXml;
@@ -55,8 +59,16 @@
     public static final String OFBIZ_COMPONENT_XML_FILENAME = "ofbiz-component.xml";
 
     // this is not a UtilCache because reloading may cause problems
-    protected static Map<String, ComponentConfig> componentConfigs = FastMap.newInstance();
-    protected static Map<String, List<WebappInfo>> serverWebApps = FastMap.newInstance();
+    protected static Map<String, ComponentConfig> componentConfigs = new LinkedHashMap<String, ComponentConfig>();
+    protected static Map<String, ComponentConfig> frameworkComponentConfigs = new LinkedHashMap<String, ComponentConfig>();
+    protected static Map<String, ComponentConfig> applicationsComponentConfigs = new LinkedHashMap<String, ComponentConfig>();
+    protected static Map<String, ComponentConfig> specialpurposeComponentConfigs = new LinkedHashMap<String, ComponentConfig>();
+    protected static Map<String, ComponentConfig> themesComponentConfigs = new LinkedHashMap<String, ComponentConfig>();
+    protected static Map<String, ComponentConfig> hotDeployComponentConfigs = new LinkedHashMap<String, ComponentConfig>();
+    protected static Map<String, ComponentConfig> defaultHotDeployComponentConfigs = new LinkedHashMap<String, ComponentConfig>();
+    protected static Map<String, List<WebappInfo>> serverWebApps = new LinkedHashMap<String, List<WebappInfo>>();
+    
+    protected static List<String> defaultTenantComponentNames = null;
 
     public static ComponentConfig getComponentConfig(String globalName) throws ComponentException {
         // TODO: we need to look up the rootLocation from the container config, or this will blow up
@@ -64,6 +76,7 @@
     }
 
     public static ComponentConfig getComponentConfig(String globalName, String rootLocation) throws ComponentException {
+        String ofbizHome = System.getProperty("ofbiz.home");
         ComponentConfig componentConfig = null;
         if (UtilValidate.isNotEmpty(globalName)) {
             componentConfig = componentConfigs.get(globalName);
@@ -80,6 +93,24 @@
                             Debug.logWarning("WARNING: Loading ofbiz-component using a global name that already exists, will over-write: " + componentConfig.getGlobalName(), module);
                         }
                         if (componentConfig.enabled()) {
+                            String componentLocation = rootLocation.substring(rootLocation.indexOf(ofbizHome) + ofbizHome.length() + 1, rootLocation.length());
+                            if (componentLocation.startsWith("framework") || "tenant".equals(componentConfig.getComponentName())) {
+                                frameworkComponentConfigs.put(componentConfig.getComponentName(),componentConfig);
+                            } else if (componentLocation.startsWith("applications")) {
+                                applicationsComponentConfigs.put(componentConfig.getComponentName(), componentConfig);
+                            } else if (componentLocation.startsWith("specialpurpose")) {
+                                specialpurposeComponentConfigs.put(componentConfig.getComponentName(), componentConfig);
+                            } else if (componentLocation.startsWith("themes")) {
+                                themesComponentConfigs.put(componentConfig.getComponentName(), componentConfig);
+                            } else if (componentLocation.startsWith("hot-deploy") && !"tenant".equals(componentConfig.getComponentName())) {
+                                List<String> defaultTenantComponentNames = getDefaultTenantComponentNames();
+                                if (defaultTenantComponentNames.contains(componentConfig.getComponentName())) {
+                                    defaultHotDeployComponentConfigs.put(componentConfig.getComponentName(), componentConfig);
+                                } else {
+                                    hotDeployComponentConfigs.put(componentConfig.getComponentName(), componentConfig);
+                                }
+                            }
+                            
                             componentConfigs.put(componentConfig.getGlobalName(), componentConfig);
                         }
                     }
@@ -109,7 +140,152 @@
             return FastList.newInstance();
         }
     }
+    
+    public static Collection<ComponentConfig> getFrameworkComponents() {
+        Collection<ComponentConfig> values = frameworkComponentConfigs.values();
+        if (values != null) {
+            return values;
+        } else {
+            Debug.logWarning("No framework components were found, something is probably missing or incorrect in the component-load setup.", module);
+            return new LinkedList<ComponentConfig>();
+        }
+    }
 
+    public static Collection<ComponentConfig> getApplicationsComponents() {
+        Collection<ComponentConfig> values = applicationsComponentConfigs.values();
+        if (values != null) {
+            return values;
+        } else {
+            Debug.logWarning("No applications components were found, something is probably missing or incorrect in the component-load setup.", module);
+            return new LinkedList<ComponentConfig>();
+        }
+    }
+
+    public static Collection<ComponentConfig> getSpecialpurposeComponents() {
+        Collection<ComponentConfig> values = specialpurposeComponentConfigs.values();
+        if (values != null) {
+            return values;
+        } else {
+            Debug.logWarning("No specialpurpose components were found, something is probably missing or incorrect in the component-load setup.", module);
+            return new LinkedList<ComponentConfig>();
+        }
+    }
+
+    public static Collection<ComponentConfig> getThemesComponents() {
+        Collection<ComponentConfig> values = themesComponentConfigs.values();
+        if (values != null) {
+            return values;
+        } else {
+            Debug.logWarning("No themes components were found, something is probably missing or incorrect in the component-load setup.", module);
+            return new LinkedList<ComponentConfig>();
+        }
+    }
+
+    public static Collection<ComponentConfig> getHotDeployComponents() {
+        Collection<ComponentConfig> values = hotDeployComponentConfigs.values();
+        if (values != null) {
+            return values;
+        } else {
+            Debug.logWarning("No hot-deploy components were found, something is probably missing or incorrect in the component-load setup.", module);
+            return new LinkedList<ComponentConfig>();
+        }
+    }
+
+    public static ComponentConfig getHotDeployComponent(String componentName) {
+        ComponentConfig value = hotDeployComponentConfigs.get(componentName);
+        if (value != null) {
+            return value;
+        } else {
+            value = defaultHotDeployComponentConfigs.get(componentName);
+            if (value != null) {
+                return value;
+            } else {
+                Debug.logWarning("No hot-deploy component[" + componentName + "] were found, something is probably missing or incorrect in the component-load setup.", module);
+                return null;
+            }
+        }
+    }
+
+    public static Collection<ComponentConfig> getDefaultHotDeployComponents() {
+        Collection<ComponentConfig> values = defaultHotDeployComponentConfigs.values();
+        if (values != null) {
+            return values;
+        } else {
+            Debug.logWarning("No default hot-deploy components were found, something is probably missing or incorrect in the component-load setup.", module);
+            return new LinkedList<ComponentConfig>();
+        }
+    }
+    
+    public static List<String> getDefaultHotDeployComponentNames() {
+        List<String> componentNames = new LinkedList<String>();
+        Collection<ComponentConfig> values = defaultHotDeployComponentConfigs.values();
+        if (values != null) {
+            for (ComponentConfig value : values) {
+                componentNames.add(value.getComponentName());
+            }
+        } else {
+            Debug.logWarning("No default hot-deploy components were found, something is probably missing or incorrect in the component-load setup.", module);
+            return FastList.newInstance();
+        }
+        return componentNames;
+    }
+    
+    public static Collection<ComponentConfig> getTenantComponents(List<String> componentNames) {
+        Collection<ComponentConfig> components = new LinkedList<ComponentConfig>();
+        if (UtilValidate.isEmpty(componentNames)) {
+            components.addAll(ComponentConfig.getFrameworkComponents());
+            components.addAll(ComponentConfig.getApplicationsComponents());
+            components.addAll(ComponentConfig.getSpecialpurposeComponents());
+            components.addAll(ComponentConfig.getThemesComponents());
+            if (!"Y".equals(UtilProperties.getPropertyValue("general", "multitenant"))) {
+                components.addAll(ComponentConfig.getHotDeployComponents());
+            }
+        } else {
+            components.addAll(ComponentConfig.getFrameworkComponents());
+            components.addAll(ComponentConfig.getApplicationsComponents());
+            components.addAll(ComponentConfig.getSpecialpurposeComponents());
+            components.addAll(ComponentConfig.getThemesComponents());
+            for (String componentName : componentNames) {
+                ComponentConfig component = ComponentConfig.getHotDeployComponent(componentName);
+                if (UtilValidate.isNotEmpty(component)) {
+                    components.add(component);
+                }
+            }
+        }
+        return components;
+    }
+    
+    public static Collection<ComponentConfig> getDefaultTenantComponents() {
+        Collection<ComponentConfig> components = new LinkedList<ComponentConfig>();
+        components.addAll(ComponentConfig.getFrameworkComponents());
+        components.addAll(ComponentConfig.getApplicationsComponents());
+        components.addAll(ComponentConfig.getSpecialpurposeComponents());
+        components.addAll(ComponentConfig.getThemesComponents());
+        components.addAll(ComponentConfig.getDefaultHotDeployComponents());
+        return components;
+    }
+    
+    public static List<String> getDefaultTenantComponentNames() {
+        if (UtilValidate.isEmpty(defaultTenantComponentNames)) {
+            defaultTenantComponentNames = new LinkedList<String>();
+            try {
+                String ofbizHome = System.getProperty("ofbiz.home");
+                File defaultTenantFile = FileUtil.getFile(new File(ofbizHome), "hot-deploy/tenant/config/default-tenant.xml");
+                if (defaultTenantFile.exists()) {
+                    Document document = UtilXml.readXmlDocument(defaultTenantFile.toURI().toURL());
+                    List<? extends Element> componentElements = UtilXml.childElementList(document.getDocumentElement(), "component");
+                    for (Element componentElement : componentElements) {
+                        String componentName = UtilXml.elementAttribute(componentElement, "name", null);
+                        defaultTenantComponentNames.add(componentName);
+                    }
+                }
+            } catch (Exception e) {
+                Debug.logWarning(e, module);
+            }
+        }
+        return defaultTenantComponentNames;
+    }
+
     public static List<ClasspathInfo> getAllClasspathInfos() {
         return getAllClasspathInfos(null);
     }
@@ -341,6 +517,27 @@
         }
         return info;
     }
+    
+    public static WebappInfo getWebAppInfo(String serverName, String hostName, String contextRoot) {
+        ComponentConfig.WebappInfo info = null;
+        if (serverName == null || contextRoot == null) {
+            return info;
+        }
+    
+        for (ComponentConfig cc: getAllComponents()) {
+            for (WebappInfo wInfo: cc.getWebappInfos()) {
+                if (serverName.equals(wInfo.server) && contextRoot.equals(wInfo.getContextRoot())) {
+                    List<String> virtualHosts = wInfo.getVirtualHosts();
+                    if (UtilValidate.isNotEmpty(virtualHosts) && virtualHosts.contains(hostName)) {
+                        return wInfo;
+                    } else {
+                        info = wInfo;
+                    }
+                }
+            }
+        }
+        return info;
+    }
 
     // ========== component info fields ==========
     protected String globalName = null;
Index: framework/entity/entitydef/entitygroup.xml
===================================================================
--- framework/entity/entitydef/entitygroup.xml	(revision 1494668)
+++ framework/entity/entitydef/entitygroup.xml	(working copy)
@@ -29,4 +29,5 @@
 <!--     <entity-group group="org.ofbiz.tenant" entity="TenantUserLogin"/> -->
     <entity-group group="org.ofbiz.tenant" entity="Component"/>
     <entity-group group="org.ofbiz.tenant" entity="TenantComponent"/>
+    <entity-group group="org.ofbiz.tenant" entity="TenantDomainName"/>
 </entitygroup>
Index: framework/entity/src/org/ofbiz/entity/DelegatorFactory.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/DelegatorFactory.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/DelegatorFactory.java	(working copy)
@@ -56,4 +56,8 @@
             delegatorCache.putIfAbsent(delegatorName, delegator);
         } while (true);
     }
+    
+    public static void removeDelegator(String delegatorName) {
+        delegatorCache.remove(delegatorName);
+    }
 }
Index: framework/entity/src/org/ofbiz/entity/GenericDelegator.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/GenericDelegator.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/GenericDelegator.java	(working copy)
@@ -36,6 +36,7 @@
 
 import javax.xml.parsers.ParserConfigurationException;
 
+import org.ofbiz.base.component.ComponentConfig;
 import org.ofbiz.base.concurrent.ExecutionPool;
 import org.ofbiz.base.util.Debug;
 import org.ofbiz.base.util.GeneralRuntimeException;
@@ -74,6 +75,7 @@
 import org.ofbiz.entity.util.EntityCrypto;
 import org.ofbiz.entity.util.EntityFindOptions;
 import org.ofbiz.entity.util.EntityListIterator;
+import org.ofbiz.entity.util.EntityUtil;
 import org.ofbiz.entity.util.SequenceUtil;
 import org.w3c.dom.Document;
 import org.w3c.dom.Element;
@@ -207,6 +209,7 @@
         //if (Debug.infoOn()) Debug.logInfo("Creating new Delegator with name \"" + delegatorFullName + "\".", module);
         this.setDelegatorNames(delegatorFullName);
         this.delegatorInfo = EntityConfigUtil.getDelegator(delegatorBaseName);
+ 		List<String> componentNames = null;
 
         String kekText;
         // before continuing, if there is a tenantId use the base delegator to see if it is valid
@@ -215,21 +218,27 @@
             GenericValue tenant = baseDelegator.findOne("Tenant", true, "tenantId", this.delegatorTenantId);
             if (tenant == null) {
                 throw new GenericEntityException("No Tenant record found for delegator [" + this.delegatorFullName + "] with tenantId [" + this.delegatorTenantId + "]");
-            } else if ("Y".equals(tenant.getString("disabled"))) {
+            }/* else if ("Y".equals(tenant.getString("disabled"))) {
                 throw new GenericEntityException("No Tenant record found for delegator [" + this.delegatorFullName + "] with tenantId [" + this.delegatorTenantId + "]");
-            }
+            }*/
             GenericValue kekValue = baseDelegator.findOne("TenantKeyEncryptingKey", true, "tenantId", getDelegatorTenantId());
             if (kekValue != null) {
                 kekText = kekValue.getString("kekText");
             } else {
                 kekText = this.delegatorInfo.getKeyEncryptingKey();
             }
+
+            // get tenant components
+            List<GenericValue> tenantComponents = baseDelegator.findByAnd("TenantComponent", UtilMisc.toMap("tenantId", this.delegatorTenantId), UtilMisc.toList("sequenceNum"), false);
+            componentNames = EntityUtil.getFieldListFromEntityList(tenantComponents, "componentName", true);
+
         } else {
+            componentNames = ComponentConfig.getDefaultHotDeployComponentNames();
             kekText = this.delegatorInfo.getKeyEncryptingKey();
         }
 
-        this.modelReader = ModelReader.getModelReader(delegatorBaseName);
-        this.modelGroupReader = ModelGroupReader.getModelGroupReader(delegatorBaseName);
+        this.modelReader = ModelReader.getModelReader(delegatorBaseName, delegatorTenantId, componentNames);
+        this.modelGroupReader = ModelGroupReader.getModelGroupReader(delegatorBaseName, delegatorTenantId, componentNames);
 
         cache = new Cache(delegatorFullName);
 
Index: framework/entity/src/org/ofbiz/entity/config/model/Datasource.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/config/model/Datasource.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/config/model/Datasource.java	(working copy)
@@ -78,9 +78,9 @@
     private final int maxWorkerPoolSize; // type = xs:integer
     private final List<SqlLoadPath> sqlLoadPathList; // <sql-load-path>
     private final List<ReadData> readDataList; // <read-data>
-    private final InlineJdbc inlineJdbc; // <inline-jdbc>
     private final JndiJdbc jndiJdbc; // <jndi-jdbc>
     private final TyrexDataSource tyrexDataSource; // <tyrex-dataSource>
+    public InlineJdbc inlineJdbc; // <inline-jdbc>
 
     Datasource(Element element) throws GenericEntityConfException {
         String lineNumberText = EntityConfigUtil.createConfigFileLineNumberText(element);
Index: framework/entity/src/org/ofbiz/entity/config/model/InlineJdbc.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/config/model/InlineJdbc.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/config/model/InlineJdbc.java	(working copy)
@@ -32,7 +32,7 @@
 public final class InlineJdbc extends JdbcElement {
 
     private final String jdbcDriver; // type = xs:string
-    private final String jdbcUri; // type = xs:string
+    private String jdbcUri; // type = xs:string
     private final String jdbcUsername; // type = xs:string
     private final String jdbcPassword; // type = xs:string
     private final String jdbcPasswordLookup; // type = xs:string
@@ -225,4 +225,11 @@
     public String getPoolXaWrapperClass() {
         return this.poolXaWrapperClass;
     }
+    /**
+     * Set JDBC URI
+     * @param jdbcUri
+     */
+    public void setJdbcUri(String jdbcUri) {
+    	this.jdbcUri = jdbcUri;
+    }
 }
Index: framework/entity/src/org/ofbiz/entity/util/EntitySaxReader.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/util/EntitySaxReader.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/util/EntitySaxReader.java	(working copy)
@@ -237,7 +237,7 @@
             Debug.logWarning("location URL was null, doing nothing", module);
             return 0;
         }
-        Debug.logImportant("Beginning import from URL: " + location.toExternalForm(), module);
+        Debug.logImportant("Beginning import [" + delegator.getDelegatorName() + "] from URL: " + location.toExternalForm(), module);
         InputStream is = null;
         long numberRead = 0;
         try {
@@ -287,7 +287,7 @@
             boolean beganTransaction = false;
             if (transactionTimeout > -1) {
                 beganTransaction = TransactionUtil.begin(transactionTimeout);
-                Debug.logImportant("Transaction Timeout set to " + transactionTimeout / 3600 + " hours (" + transactionTimeout + " seconds)", module);
+                Debug.logImportant("Transaction Timeout [" + delegator.getDelegatorName() + "] set to " + transactionTimeout / 3600 + " hours (" + transactionTimeout + " seconds)", module);
             }
             try {
                 parser.parse(is);
@@ -310,7 +310,7 @@
         } catch (GenericTransactionException e) {
             throw new SAXException("A transaction error occurred reading data", e);
         }
-        Debug.logImportant("Finished " + numberRead + " values from " + docDescription, module);
+        Debug.logImportant("Finished [" + delegator.getDelegatorName() + "] " + numberRead + " values from " + docDescription, module);
         if (Debug.verboseOn()) { 
             Debug.logVerbose("  Detail created : " + numberCreated + ", skipped : " + numberSkipped +
                     ", updated : " + numberUpdated + ", replaced : " + numberReplaced +
Index: framework/entity/src/org/ofbiz/entity/datasource/GenericDAO.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/datasource/GenericDAO.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/datasource/GenericDAO.java	(working copy)
@@ -1232,11 +1232,14 @@
     public void checkDb(Map<String, ModelEntity> modelEntities, List<String> messages, boolean addMissing) {
         DatabaseUtil dbUtil = new DatabaseUtil(this.helperInfo, this.executor);
         dbUtil.checkDb(modelEntities, messages, addMissing);
+        dbUtil.close();
     }
 
     /** Creates a list of ModelEntity objects based on meta data from the database */
     public List<ModelEntity> induceModelFromDb(Collection<String> messages) {
         DatabaseUtil dbUtil = new DatabaseUtil(this.helperInfo, this.executor);
-        return dbUtil.induceModelFromDb(messages);
+        List<ModelEntity> modelEntities = dbUtil.induceModelFromDb(messages);
+        dbUtil.close();
+        return modelEntities;
     }
 }
Index: framework/entity/src/org/ofbiz/entity/connection/DBCPConnectionFactory.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/connection/DBCPConnectionFactory.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/connection/DBCPConnectionFactory.java	(working copy)
@@ -22,6 +22,7 @@
 import java.sql.Driver;
 import java.sql.SQLException;
 import java.util.HashMap;
+import java.util.LinkedHashMap;
 import java.util.Map;
 import java.util.Properties;
 import java.util.concurrent.ConcurrentHashMap;
@@ -53,6 +54,8 @@
 
     public static final String module = DBCPConnectionFactory.class.getName();
     protected static final ConcurrentHashMap<String, ManagedDataSource> dsCache = new ConcurrentHashMap<String, ManagedDataSource>();
+    protected static Map<String, XAConnectionFactory> xacfCache = new LinkedHashMap<String, XAConnectionFactory>();
+    protected static Map<String, GenericObjectPool> gopCache = new LinkedHashMap<String, GenericObjectPool>();
 
     public Connection getConnection(GenericHelperInfo helperInfo, JdbcElement abstractJdbc) throws SQLException, GenericEntityException {
         String cacheKey = helperInfo.getHelperFullName();
@@ -139,15 +142,29 @@
         // cache the pool
         dsCache.putIfAbsent(cacheKey, mds);
         mds = dsCache.get(cacheKey);
+            xacfCache.put(helperInfo.getHelperFullName(), xacf);
+            gopCache.put(helperInfo.getHelperFullName(), pool);
 
         return TransactionFactory.getCursorConnection(helperInfo, mds.getConnection());
     }
+    
+    public void removeConnection(GenericHelperInfo helperInfo) {
+        dsCache.remove(helperInfo.getHelperFullName());
+    }
 
     public void closeAll() {
         // no methods on the pool to shutdown; so just clearing for GC
         // Hmm... then how do we close the JDBC connections?
         dsCache.clear();
     }
+    
+    public XAConnectionFactory getXAConnectionFactory(GenericHelperInfo helperInfo) {
+        return xacfCache.get(helperInfo.getHelperFullName());
+    }
+    
+    public GenericObjectPool getGenericObjectPool(GenericHelperInfo helperInfo) {
+        return gopCache.get(helperInfo.getHelperFullName());
+    }
 
     public static Map<String, Object> getDataSourceInfo(String helperName) {
         Map<String, Object> dataSourceInfo = new HashMap<String, Object>();
Index: framework/entity/src/org/ofbiz/entity/model/ModelReader.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/model/ModelReader.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/model/ModelReader.java	(working copy)
@@ -31,6 +31,7 @@
 import java.util.TreeSet;
 
 import org.ofbiz.base.component.ComponentConfig;
+import org.ofbiz.base.component.ComponentConfig.EntityResourceInfo;
 import org.ofbiz.base.config.GenericConfigException;
 import org.ofbiz.base.config.MainResourceHandler;
 import org.ofbiz.base.config.ResourceHandler;
@@ -80,25 +81,41 @@
     protected Map<String, ResourceHandler> entityResourceHandlerMap;
 
     public static ModelReader getModelReader(String delegatorName) throws GenericEntityException {
-        DelegatorElement delegatorInfo = EntityConfigUtil.getDelegator(delegatorName);
+        return getModelReader(delegatorName, null, null);
+    }
 
+    public static ModelReader getModelReader(String delegatorBaseName, String tenantId, List<String> componentNames) throws GenericEntityException {
+    	DelegatorElement delegatorInfo = EntityConfigUtil.getDelegator(delegatorBaseName);
+
         if (delegatorInfo == null) {
-            throw new GenericEntityConfException("Could not find a delegator with the name " + delegatorName);
+            throw new GenericEntityConfException("Could not find a delegator with the name " + delegatorBaseName);
         }
 
         String tempModelName = delegatorInfo.getEntityModelReader();
-        ModelReader reader = readers.get(tempModelName);
+        String delegatorName = delegatorBaseName;
+        if (UtilValidate.isNotEmpty(tenantId)) {
+            delegatorName += "#" + tenantId;
+        }
+        ModelReader reader = readers.get(delegatorName);
 
         if (reader == null) {
-            reader = new ModelReader(tempModelName);
+            if (UtilValidate.isEmpty(componentNames)) {
+                reader = new ModelReader(tempModelName);
+            } else {
+                reader = new ModelReader(tempModelName, componentNames);
+            }
             // preload caches...
             reader.getEntityCache();
-            reader = readers.putIfAbsentAndGet(tempModelName, reader);
+            reader = readers.putIfAbsentAndGet(delegatorName, reader);
         }
         return reader;
     }
 
     private ModelReader(String modelName) throws GenericEntityException {
+        this(modelName, null);
+    }
+
+    private ModelReader(String modelName, List<String> componentNames) throws GenericEntityException {
         this.modelName = modelName;
         entityResourceHandlers = new LinkedList<ResourceHandler>();
         resourceHandlerEntities = new HashMap<ResourceHandler, Collection<String>>();
@@ -115,9 +132,17 @@
             ResourceHandler handler = new MainResourceHandler(EntityConfigUtil.ENTITY_ENGINE_XML_FILENAME, resourceElement.getLoader(), resourceElement.getLocation());
             entityResourceHandlers.add(handler);
         }
-
-        // get all of the component resource model stuff, ie specified in each ofbiz-component.xml file
-        for (ComponentConfig.EntityResourceInfo componentResourceInfo: ComponentConfig.getAllEntityResourceInfos("model")) {
+        
+        // get entity resource infos
+        List<EntityResourceInfo> entityResourceInfos = new LinkedList<EntityResourceInfo>();
+        Collection<ComponentConfig> components = ComponentConfig.getTenantComponents(componentNames);
+        for (ComponentConfig component : components) {
+            List<EntityResourceInfo> componentEntityResourceInfos = ComponentConfig.getAllEntityResourceInfos("model", component.getComponentName());
+            entityResourceInfos.addAll(componentEntityResourceInfos);
+        }
+        
+        // create resource handlers
+        for (ComponentConfig.EntityResourceInfo componentResourceInfo: entityResourceInfos) {
             if (modelName.equals(componentResourceInfo.readerName)) {
                 entityResourceHandlers.add(componentResourceInfo.createResourceHandler());
             }
Index: framework/entity/src/org/ofbiz/entity/model/ModelGroupReader.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/model/ModelGroupReader.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/model/ModelGroupReader.java	(working copy)
@@ -19,6 +19,7 @@
 package org.ofbiz.entity.model;
 
 import java.io.Serializable;
+import java.util.Collection;
 import java.util.HashMap;
 import java.util.HashSet;
 import java.util.LinkedList;
@@ -28,6 +29,7 @@
 import java.util.TreeSet;
 
 import org.ofbiz.base.component.ComponentConfig;
+import org.ofbiz.base.component.ComponentConfig.EntityResourceInfo;
 import org.ofbiz.base.config.GenericConfigException;
 import org.ofbiz.base.config.MainResourceHandler;
 import org.ofbiz.base.config.ResourceHandler;
@@ -62,22 +64,38 @@
     public List<ResourceHandler> entityGroupResourceHandlers = new LinkedList<ResourceHandler>();
 
     public static ModelGroupReader getModelGroupReader(String delegatorName) throws GenericEntityConfException {
-        DelegatorElement delegatorInfo = EntityConfigUtil.getDelegator(delegatorName);
+        return getModelGroupReader(delegatorName, null, null);
+    }
+    public static ModelGroupReader getModelGroupReader(String delegatorBaseName, String tenantId, List<String> componentNames) throws GenericEntityConfException {
+    	DelegatorElement delegatorInfo = EntityConfigUtil.getDelegator(delegatorBaseName);
 
         if (delegatorInfo == null) {
-            throw new GenericEntityConfException("Could not find a delegator with the name " + delegatorName);
+            throw new GenericEntityConfException("Could not find a delegator with the name " + delegatorBaseName);
         }
 
         String tempModelName = delegatorInfo.getEntityGroupReader();
-        ModelGroupReader reader = readers.get(tempModelName);
+        String delegatorName = delegatorBaseName;
+        if (UtilValidate.isNotEmpty(tenantId)) {
+            delegatorName += "#" + tenantId;
+        }
+        ModelGroupReader reader = readers.get(delegatorName);
 
         if (reader == null) {
-            reader = readers.putIfAbsentAndGet(tempModelName, new ModelGroupReader(tempModelName));
+            if (UtilValidate.isEmpty(componentNames)) {
+                reader = new ModelGroupReader(tempModelName);
+            } else {
+                reader = new ModelGroupReader(tempModelName, componentNames);
+            }
+            reader = readers.putIfAbsentAndGet(delegatorName, reader);
         }
         return reader;
     }
 
     public ModelGroupReader(String modelName) throws GenericEntityConfException {
+        this(modelName, null);
+    }
+    
+    public ModelGroupReader(String modelName, List<String> componentNames) throws GenericEntityConfException {
         this.modelName = modelName;
         EntityGroupReader entityGroupReaderInfo = EntityConfigUtil.getEntityGroupReader(modelName);
 
@@ -88,8 +106,16 @@
             this.entityGroupResourceHandlers.add(new MainResourceHandler(EntityConfigUtil.ENTITY_ENGINE_XML_FILENAME, resourceElement.getLoader(), resourceElement.getLocation()));
         }
 
-        // get all of the component resource group stuff, ie specified in each ofbiz-component.xml file
-        for (ComponentConfig.EntityResourceInfo componentResourceInfo: ComponentConfig.getAllEntityResourceInfos("group")) {
+        // get entity resource infos
+        List<EntityResourceInfo> entityResourceInfos = new LinkedList<EntityResourceInfo>();
+        Collection<ComponentConfig> components = ComponentConfig.getTenantComponents(componentNames);
+        for (ComponentConfig component : components) {
+            List<EntityResourceInfo> componentEntityResourceInfos = ComponentConfig.getAllEntityResourceInfos("group", component.getComponentName());
+            entityResourceInfos.addAll(componentEntityResourceInfos);
+        }
+        
+        // create resource handlers
+        for (ComponentConfig.EntityResourceInfo componentResourceInfo: entityResourceInfos) {
             if (modelName.equals(componentResourceInfo.readerName)) {
                 this.entityGroupResourceHandlers.add(componentResourceInfo.createResourceHandler());
             }
Index: framework/entity/src/org/ofbiz/entity/jdbc/DatabaseUtil.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/jdbc/DatabaseUtil.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/jdbc/DatabaseUtil.java	(working copy)
@@ -82,6 +82,7 @@
 
     boolean isLegacy = false;
     protected ExecutorService executor;
+    protected List<Connection> connections = new LinkedList<Connection>();
 
     // OFBiz DatabaseUtil
     public DatabaseUtil(GenericHelperInfo helperInfo) {
@@ -144,6 +145,9 @@
                 throw new GenericEntityException("No connection avaialble for URL [" + connectionUrl + "]");
             }
         }
+        
+        connections.add(connection);
+        
         if (!TransactionUtil.isTransactionInPlace()) {
             connection.setAutoCommit(true);
         }
@@ -3192,6 +3196,18 @@
             }
         }
     }
+    
+    public void close() {
+        for (Connection connection : connections) {
+            try {
+                if (!connection.isClosed()) {
+                    connection.close();
+                }
+            } catch (SQLException e) {
+                Debug.logWarning("Could not close connection: " + connection, module);
+            }
+        }
+    }
 
     /* ====================================================================== */
     /* ====================================================================== */
Index: framework/entity/src/org/ofbiz/entity/jdbc/ConnectionFactory.java
===================================================================
--- framework/entity/src/org/ofbiz/entity/jdbc/ConnectionFactory.java	(revision 1494668)
+++ framework/entity/src/org/ofbiz/entity/jdbc/ConnectionFactory.java	(working copy)
@@ -101,7 +101,7 @@
         return con;
     }
 
-    private static ConnectionFactoryInterface getManagedConnectionFactory() {
+    public static ConnectionFactoryInterface getManagedConnectionFactory() {
         ConnectionFactoryInterface instance = connFactoryRef.get();
         if (instance == null) {
             try {
Index: framework/webapp/src/org/ofbiz/webapp/control/ControlEventListener.java
===================================================================
--- framework/webapp/src/org/ofbiz/webapp/control/ControlEventListener.java	(revision 1494668)
+++ framework/webapp/src/org/ofbiz/webapp/control/ControlEventListener.java	(working copy)
@@ -81,6 +81,12 @@
                 if (visit != null) {
                     visit.set("thruDate", new Timestamp(session.getLastAccessedTime()));
                     visit.store();
+                    //also set hasLoggedOut as "Y"
+                    GenericValue userLoginMap = delegator.findOne("UserLogin", UtilMisc.toMap("userLoginId", visit.get("userLoginId")), false);
+                    if (UtilValidate.isNotEmpty(userLoginMap)) {
+                        userLoginMap.set("hasLoggedOut", "Y");
+                        userLoginMap.store();
+                    }
                 }
             } else {
                 Debug.logWarning("Could not find visit value object in session [" + session.getId() + "] that is being destroyed", module);
Index: framework/webapp/src/org/ofbiz/webapp/control/ContextFilter.java
===================================================================
--- framework/webapp/src/org/ofbiz/webapp/control/ContextFilter.java	(revision 1494668)
+++ framework/webapp/src/org/ofbiz/webapp/control/ContextFilter.java	(working copy)
@@ -260,16 +260,27 @@
             // get tenant delegator by domain name
             String serverName = httpRequest.getServerName();
             try {
+               // first set the delegator to default
+                String delegatorName = config.getServletContext().getInitParameter("entityDelegatorName");
+
+                if (delegatorName == null || delegatorName.length() <= 0) {
+                    delegatorName = "default";
+                }
+                if (Debug.verboseOn()) Debug.logVerbose("Setup Entity Engine Delegator with name " + delegatorName, module);
+                Delegator delegator = DelegatorFactory.getDelegator(delegatorName);
+                config.getServletContext().setAttribute("delegator", delegator);
+                if (delegator == null) {
+                    Debug.logError("[ContextFilter.init] ERROR: delegator factory returned null for delegatorName \"" + delegatorName + "\"", module);
+                }
                 // if tenant was specified, replace delegator with the new per-tenant delegator and set tenantId to session attribute
-                Delegator delegator = getDelegator(config.getServletContext());
-                List<GenericValue> tenants = delegator.findList("Tenant", EntityCondition.makeCondition("domainName", serverName), null, UtilMisc.toList("-createdStamp"), null, false);
-                if (UtilValidate.isNotEmpty(tenants)) {
-                    GenericValue tenant = EntityUtil.getFirst(tenants);
-                    String tenantId = tenant.getString("tenantId");
+                List<GenericValue> tenantDomainNames = delegator.findList("TenantDomainName", EntityCondition.makeCondition("domainName", serverName), null, UtilMisc.toList("-createdStamp"), null, false);
+                if (UtilValidate.isNotEmpty(tenantDomainNames)) {
+                    GenericValue tenantDomainName = EntityUtil.getFirst(tenantDomainNames);
+                    String tenantId = tenantDomainName.getString("tenantId");
 
                     // if the request path is a root mount then redirect to the initial path
                     if (UtilValidate.isNotEmpty(requestPath) && requestPath.equals(contextUri)) {
-                        String initialPath = tenant.getString("initialPath");
+                        String initialPath = tenantDomainName.getString("initialPath");
                         if (UtilValidate.isNotEmpty(initialPath) && !"/".equals(initialPath)) {
                             ((HttpServletResponse)response).sendRedirect(initialPath);
                             return;
@@ -282,23 +293,25 @@
 
                     // after this line the delegator is replaced with the new per-tenant delegator
                     delegator = DelegatorFactory.getDelegator(tenantDelegatorName);
-                    config.getServletContext().setAttribute("delegator", delegator);
-
-                    // clear web context objects
-                    config.getServletContext().setAttribute("security", null);
-                    config.getServletContext().setAttribute("dispatcher", null);
-
-                    // initialize security
-                    Security security = getSecurity();
-                    // initialize the services dispatcher
-                    LocalDispatcher dispatcher = getDispatcher(config.getServletContext());
-
-                    // set web context objects
-                    request.setAttribute("dispatcher", dispatcher);
-                    request.setAttribute("security", security);
                     
                     request.setAttribute("tenantId", tenantId);
                 }
+                
+                config.getServletContext().setAttribute("delegator", delegator);
+                
+                // clear web context objects
+                config.getServletContext().setAttribute("authorization", null);
+                config.getServletContext().setAttribute("security", null);
+                config.getServletContext().setAttribute("dispatcher", null);
+                
+                // initialize security
+                Security security = getSecurity();
+                // initialize the services dispatcher
+                LocalDispatcher dispatcher = getDispatcher(config.getServletContext());
+                
+                // set web context objects
+                httpRequest.getSession().setAttribute("dispatcher", dispatcher);
+                httpRequest.getSession().setAttribute("security", security);
 
                 // NOTE DEJ20101130: do NOT always put the delegator name in the user's session because the user may 
                 // have logged in and specified a tenant, and even if no Tenant record with a matching domainName field 
Index: framework/webapp/src/org/ofbiz/webapp/control/LoginWorker.java
===================================================================
--- framework/webapp/src/org/ofbiz/webapp/control/LoginWorker.java	(revision 1494668)
+++ framework/webapp/src/org/ofbiz/webapp/control/LoginWorker.java	(working copy)
@@ -306,6 +306,7 @@
     public static String login(HttpServletRequest request, HttpServletResponse response) {
         HttpSession session = request.getSession();
 
+        String sessionId = session.getId();
         String username = request.getParameter("USERNAME");
         String password = request.getParameter("PASSWORD");
 
@@ -640,9 +641,11 @@
         if (currCatalog != null) session.setAttribute("CURRENT_CATALOG_ID", currCatalog);
         if (delegatorName != null) {
             // if there is a tenantId in the delegatorName remove it now so that tenant selection doesn't last beyond logout
+        	/*
             if (delegatorName.indexOf('#') > 0) {
                 delegatorName = delegatorName.substring(0, delegatorName.indexOf('#'));
             }
+            */
             session.setAttribute("delegatorName", delegatorName);
 
             delegator = DelegatorFactory.getDelegator(delegatorName);
@@ -1015,7 +1018,7 @@
                 contextPath = "/";
             }
             
-            ComponentConfig.WebappInfo info = ComponentConfig.getWebAppInfo(serverId, contextPath);
+            ComponentConfig.WebappInfo info = ComponentConfig.getWebAppInfo(serverId, request.getServerName(), contextPath);
             if (info != null) {
                 for (String permission: info.getBasePermission()) {
                     if (!"NONE".equals(permission) && !security.hasEntityPermission(permission, "_VIEW", userLogin)) {
Index: framework/common/config/general.properties
===================================================================
--- framework/common/config/general.properties	(revision 1494668)
+++ framework/common/config/general.properties	(working copy)
@@ -136,7 +136,7 @@
 http.localhost=ABQIAAAAtt0d8djaYFkk8N5LJVcDSBT2yXp_ZAY8_ufC3CFXhHIE1NvwkxR3euHYk9bpwvdF2Qg1EYO1LQitHA
 
 # -- Y if you want to display the multi-tenant textbox in the login page and install specify components which related to each tenant
-multitenant=N
+multitenant=Y
 
 # -- Y if you use a cluster. Most of the time this should not be needed. Setting distributed-cache-clear-enabled="true" is enough 
 # -- to guarantee no sequenceIds duplicates. See OFBIZ-2353 for details
Index: framework/common/webcommon/login.ftl
===================================================================
--- framework/common/webcommon/login.ftl	(revision 1494668)
+++ framework/common/webcommon/login.ftl	(working copy)
@@ -42,6 +42,7 @@
             <td class="label">${uiLabelMap.CommonPassword}</td>
             <td><input type="password" name="PASSWORD" value="" size="20"/></td>
           </tr>
+          <#--
           <#if ("Y" == useMultitenant) >
               <#if !requestAttributes.tenantId?exists>
                   <tr>
@@ -52,6 +53,7 @@
                   <input type="hidden" name="tenantId" value="${requestAttributes.tenantId?if_exists}"/>
               </#if>
           </#if>
+          -->
           <tr>
             <td colspan="2" align="center">
               <input type="submit" value="${uiLabelMap.CommonLogin}"/>
Index: framework/common/src/org/ofbiz/common/UrlServletHelper.java
===================================================================
--- framework/common/src/org/ofbiz/common/UrlServletHelper.java	(revision 1494668)
+++ framework/common/src/org/ofbiz/common/UrlServletHelper.java	(working copy)
@@ -55,20 +55,31 @@
             // get tenant delegator by domain name
             String serverName = request.getServerName();
             try {
+                // first set the delegator to default
+                String delegatorName = servletContext.getInitParameter("entityDelegatorName");
+
+                if (delegatorName == null || delegatorName.length() <= 0) {
+                    delegatorName = "default";
+                }
+                if (Debug.verboseOn()) Debug.logVerbose("Setup Entity Engine Delegator with name " + delegatorName, module);
+                delegator = DelegatorFactory.getDelegator(delegatorName);
+                servletContext.setAttribute("delegator", delegator);
+                if (delegator == null) {
+                    Debug.logError("[ContextFilter.init] ERROR: delegator factory returned null for delegatorName \"" + delegatorName + "\"", module);
+                }
+                
                 // if tenant was specified, replace delegator with the new per-tenant delegator and set tenantId to session attribute
-                delegator = getDelegator(servletContext);
-                List<GenericValue> tenants = delegator.findList("Tenant", EntityCondition.makeCondition("domainName", serverName), null, UtilMisc.toList("-createdStamp"), null, false);
-                if (UtilValidate.isNotEmpty(tenants)) {
-                    GenericValue tenant = EntityUtil.getFirst(tenants);
-                    String tenantId = tenant.getString("tenantId");
+                List<GenericValue> tenantDomainNames = delegator.findList("TenantDomainName", EntityCondition.makeCondition("domainName", serverName), null, UtilMisc.toList("-createdStamp"), null, false);
+                if (UtilValidate.isNotEmpty(tenantDomainNames)) {
+                    GenericValue tenantDomainName = EntityUtil.getFirst(tenantDomainNames);
+                    String tenantId = tenantDomainName.getString("tenantId");
                     
                     // make that tenant active, setup a new delegator and a new dispatcher
-                    String tenantDelegatorName = delegator.getDelegatorBaseName() + "#" + tenantId;
-                    httpRequest.getSession().setAttribute("delegatorName", tenantDelegatorName);
+                    delegatorName = delegator.getDelegatorBaseName() + "#" + tenantId;
+                    httpRequest.getSession().setAttribute("delegatorName", delegatorName);
                 
                     // after this line the delegator is replaced with the new per-tenant delegator
-                    delegator = DelegatorFactory.getDelegator(tenantDelegatorName);
-                    servletContext.setAttribute("delegator", delegator);
+                    delegator = DelegatorFactory.getDelegator(delegatorName);
                 }
                 
             } catch (GenericEntityException e) {
@@ -79,6 +90,7 @@
         // set the web context in the request for future use
         request.setAttribute("servletContext", httpRequest.getSession().getServletContext());
         request.setAttribute("delegator", delegator);
+        servletContext.setAttribute("delegator", delegator);
 
         // set the webSiteId in the session
         if (UtilValidate.isEmpty(httpRequest.getSession().getAttribute("webSiteId"))){
Index: framework/entityext/src/org/ofbiz/entityext/eca/EntityEcaUtil.java
===================================================================
--- framework/entityext/src/org/ofbiz/entityext/eca/EntityEcaUtil.java	(revision 1494668)
+++ framework/entityext/src/org/ofbiz/entityext/eca/EntityEcaUtil.java	(working copy)
@@ -34,12 +34,18 @@
 import org.ofbiz.base.config.MainResourceHandler;
 import org.ofbiz.base.config.ResourceHandler;
 import org.ofbiz.base.util.Debug;
+import org.ofbiz.base.util.UtilMisc;
+import org.ofbiz.base.util.UtilValidate;
 import org.ofbiz.base.util.UtilXml;
 import org.ofbiz.base.util.cache.UtilCache;
 import org.ofbiz.entity.Delegator;
+import org.ofbiz.entity.DelegatorFactory;
+import org.ofbiz.entity.GenericEntityException;
+import org.ofbiz.entity.GenericValue;
 import org.ofbiz.entity.GenericEntityConfException;
 import org.ofbiz.entity.config.EntityConfigUtil;
 import org.ofbiz.entity.config.model.*;
+import org.ofbiz.entity.util.EntityUtil;
 import org.w3c.dom.Element;
 
 /**
@@ -49,13 +55,19 @@
 
     public static final String module = EntityEcaUtil.class.getName();
 
-    private static final UtilCache<String, Map<String, Map<String, List<EntityEcaRule>>>> entityEcaReaders = UtilCache.createUtilCache("entity.EcaReaders", 0, 0, false);
+    private static final UtilCache<String, UtilCache<String, Map<String, Map<String, List<EntityEcaRule>>>>> tenantEntityEcaReaders = UtilCache.createUtilCache("entity.EcaReaders", 0, 0, false);
 
-    public static Map<String, Map<String, List<EntityEcaRule>>> getEntityEcaCache(String entityEcaReaderName) {
+    public static Map<String, Map<String, List<EntityEcaRule>>> getEntityEcaCache(String entityEcaReaderName, Delegator delegator) {
+        UtilCache<String, Map<String, Map<String, List<EntityEcaRule>>>> entityEcaReaders = tenantEntityEcaReaders.get(delegator.getDelegatorName());
+        if (UtilValidate.isEmpty(entityEcaReaders)) {
+            entityEcaReaders = UtilCache.createUtilCache("entity.EcaReaders." + delegator.getDelegatorName(), 0, 0, false);
+            tenantEntityEcaReaders.put(delegator.getDelegatorName(), entityEcaReaders);
+        }
+        
         Map<String, Map<String, List<EntityEcaRule>>> ecaCache = entityEcaReaders.get(entityEcaReaderName);
         if (ecaCache == null) {
             ecaCache = FastMap.newInstance();
-            readConfig(entityEcaReaderName, ecaCache);
+            readConfig(entityEcaReaderName, ecaCache, delegator);
             ecaCache = entityEcaReaders.putIfAbsentAndGet(entityEcaReaderName, ecaCache);
         }
         return ecaCache;
@@ -75,7 +87,7 @@
         return delegatorInfo.getEntityEcaReader();
     }
 
-    protected static void readConfig(String entityEcaReaderName, Map<String, Map<String, List<EntityEcaRule>>> ecaCache) {
+    protected static void readConfig(String entityEcaReaderName, Map<String, Map<String, List<EntityEcaRule>>> ecaCache, Delegator delegator) {
         EntityEcaReader entityEcaReaderInfo = null;
         try {
             entityEcaReaderInfo = EntityConfigUtil.getEntityEcaReader(entityEcaReaderName);
@@ -90,14 +102,29 @@
         List<Future<List<EntityEcaRule>>> futures = FastList.newInstance();
         for (Resource eecaResourceElement : entityEcaReaderInfo.getResourceList()) {
             ResourceHandler handler = new MainResourceHandler(EntityConfigUtil.ENTITY_ENGINE_XML_FILENAME, eecaResourceElement.getLoader(), eecaResourceElement.getLocation());
-            futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(handler)));
+            futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(handler, delegator)));
         }
 
         // get all of the component resource eca stuff, ie specified in each ofbiz-component.xml file
-        for (ComponentConfig.EntityResourceInfo componentResourceInfo: ComponentConfig.getAllEntityResourceInfos("eca")) {
-            if (entityEcaReaderName.equals(componentResourceInfo.readerName)) {
-                futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(componentResourceInfo.createResourceHandler())));
+        try {
+            List<String> componentNames = null;
+            if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId())) {
+                Delegator baseDelegator = DelegatorFactory.getDelegator(delegator.getDelegatorBaseName());
+                List<GenericValue> tenantComponents = baseDelegator.findByAnd("TenantComponent", UtilMisc.toMap("tenantId", delegator.getDelegatorTenantId()), null, false);
+                componentNames = EntityUtil.getFieldListFromEntityList(tenantComponents, "componentName", true);
+            } else {
+                componentNames = ComponentConfig.getDefaultHotDeployComponentNames();
             }
+            Collection<ComponentConfig> components = ComponentConfig.getTenantComponents(componentNames);
+            for (ComponentConfig component : components) {
+                for (ComponentConfig.EntityResourceInfo componentResourceInfo: ComponentConfig.getAllEntityResourceInfos("eca", component.getComponentName())) {
+                    if (entityEcaReaderName.equals(componentResourceInfo.readerName)) {
+                        futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(componentResourceInfo.createResourceHandler(), delegator)));
+                    }
+                }
+            }
+        } catch (GenericEntityException e) {
+            Debug.logError(e, module);
         }
 
         for (List<EntityEcaRule> oneFileRules: ExecutionPool.getAllFutures(futures)) {
@@ -123,7 +150,7 @@
         }
     }
 
-    private static List<EntityEcaRule> getEcaDefinitions(ResourceHandler handler) {
+    private static List<EntityEcaRule> getEcaDefinitions(ResourceHandler handler, Delegator delegator) {
         List<EntityEcaRule> rules = FastList.newInstance();
         Element rootElement = null;
         try {
@@ -136,23 +163,23 @@
             rules.add(new EntityEcaRule(e));
         }
         try {
-            Debug.logImportant("Loaded [" + StringUtil.leftPad(Integer.toString(rules.size()), 3) + "] Entity ECA definitions from " + handler.getFullLocation() + " in loader " + handler.getLoaderName(), module);
+            Debug.logImportant("Loaded [" + delegator.getDelegatorName() + "] [" + StringUtil.leftPad(Integer.toString(rules.size()), 3) + "] Entity ECA definitions from " + handler.getFullLocation() + " in loader " + handler.getLoaderName(), module);
         } catch (GenericConfigException e) {
             Debug.logError(e, module);
         }
         return rules;
     }
 
-    protected static Callable<List<EntityEcaRule>> createEcaLoaderCallable(final ResourceHandler handler) {
+    protected static Callable<List<EntityEcaRule>> createEcaLoaderCallable(final ResourceHandler handler, final Delegator delegator) {
         return new Callable<List<EntityEcaRule>>() {
             public List<EntityEcaRule> call() throws Exception {
-                return getEcaDefinitions(handler);
+                return getEcaDefinitions(handler, delegator);
             }
         };
     }
 
     public static Collection<EntityEcaRule> getEntityEcaRules(Delegator delegator, String entityName, String event) {
-        Map<String, Map<String, List<EntityEcaRule>>> ecaCache = EntityEcaUtil.getEntityEcaCache(EntityEcaUtil.getEntityEcaReaderName(delegator.getDelegatorName()));
+        Map<String, Map<String, List<EntityEcaRule>>> ecaCache = EntityEcaUtil.getEntityEcaCache(EntityEcaUtil.getEntityEcaReaderName(delegator.getDelegatorName()), delegator);
         Map<String, List<EntityEcaRule>> eventMap = ecaCache.get(entityName);
         if (eventMap != null) {
             if (event != null) {
Index: framework/entityext/src/org/ofbiz/entityext/eca/DelegatorEcaHandler.java
===================================================================
--- framework/entityext/src/org/ofbiz/entityext/eca/DelegatorEcaHandler.java	(revision 1494668)
+++ framework/entityext/src/org/ofbiz/entityext/eca/DelegatorEcaHandler.java	(working copy)
@@ -53,11 +53,11 @@
         this.dctx = EntityServiceFactory.getDispatchContext(delegator);
 
         //preload the cache
-        EntityEcaUtil.getEntityEcaCache(this.entityEcaReaderName);
+        EntityEcaUtil.getEntityEcaCache(this.entityEcaReaderName, delegator);
     }
 
     public Map<String, List<EntityEcaRule>> getEntityEventMap(String entityName) {
-        Map<String, Map<String, List<EntityEcaRule>>> ecaCache = EntityEcaUtil.getEntityEcaCache(this.entityEcaReaderName);
+        Map<String, Map<String, List<EntityEcaRule>>> ecaCache = EntityEcaUtil.getEntityEcaCache(this.entityEcaReaderName, delegator);
         if (ecaCache == null) return null;
         return ecaCache.get(entityName);
     }
Index: framework/entityext/src/org/ofbiz/entityext/data/EntityDataServices.java
===================================================================
--- framework/entityext/src/org/ofbiz/entityext/data/EntityDataServices.java	(revision 1494668)
+++ framework/entityext/src/org/ofbiz/entityext/data/EntityDataServices.java	(working copy)
@@ -407,6 +407,8 @@
         // step 8 - checkdb
         Debug.logImportant("Running DB check with add missing enabled", module);
         dbUtil.checkDb(modelEntities, messages, true);
+        
+        dbUtil.close();
 
         Map<String, Object> result = ServiceUtil.returnSuccess();
         result.put("messages", messages);
Index: framework/entityext/src/org/ofbiz/entityext/data/EntityDataLoadContainer.java
===================================================================
--- framework/entityext/src/org/ofbiz/entityext/data/EntityDataLoadContainer.java	(revision 1494668)
+++ framework/entityext/src/org/ofbiz/entityext/data/EntityDataLoadContainer.java	(working copy)
@@ -23,6 +23,7 @@
 import java.net.URL;
 import java.text.NumberFormat;
 import java.util.Collection;
+import java.util.LinkedList;
 import java.util.List;
 import java.util.Map;
 import java.util.TreeSet;
@@ -307,8 +308,20 @@
                 Debug.logError(e.getMessage(), module);
             }
         }
-        // load specify components
-        List<String> loadComponents = FastList.newInstance();
+        
+        // get standard components
+        List<ComponentConfig> standardComponents = new LinkedList<ComponentConfig>();
+        standardComponents.addAll(ComponentConfig.getFrameworkComponents());
+        standardComponents.addAll(ComponentConfig.getApplicationsComponents());
+        standardComponents.addAll(ComponentConfig.getSpecialpurposeComponents());
+        standardComponents.addAll(ComponentConfig.getThemesComponents());
+        
+        // load standard components
+        List<String> loadComponents = new LinkedList<String>();
+        for (ComponentConfig componentConfig : standardComponents) {
+            loadComponents.add(componentConfig.getComponentName());
+        }
+        
         if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId()) && "Y".equals(UtilProperties.getPropertyValue("general.properties", "multitenant"))) {
             try {
                 List<EntityExpr> exprs = FastList.newInstance();
@@ -341,6 +354,8 @@
             } catch (GenericEntityException e) {
                 Debug.logError(e.getMessage(), module);
             }
+        } else if (UtilValidate.isEmpty(delegator.getDelegatorTenantId()) && "Y".equals(UtilProperties.getPropertyValue("general.properties", "multitenant"))) {
+            loadComponents.addAll(ComponentConfig.getDefaultHotDeployComponentNames());
         }
         // check for drop index/fks
         if (dropConstraints) {
@@ -432,6 +447,16 @@
                 urlList = EntityDataLoader.getUrlList(helperInfo.getHelperBaseName(), component);
             }
         }
+        
+        // load tenant reader data from hot-deploy components if requested
+        if (UtilValidate.isNotEmpty(readerNames) && readerNames.contains("tenant")) {
+            List<String> loadHotDeployComponents = new LinkedList<String>();
+            for (ComponentConfig component : ComponentConfig.getHotDeployComponents()) {
+                loadHotDeployComponents.add(component.getComponentName());
+            }
+            urlList.addAll(EntityDataLoader.getUrlByComponentList(helperInfo.getHelperBaseName(), loadHotDeployComponents, UtilMisc.toList("tenant")));
+        }
+        
         // need a list if it is empty
         if (urlList == null) {
             urlList = FastList.newInstance();
@@ -565,6 +590,8 @@
                 }
             }
         }
+
+        dbUtil.close();
     }
     /**
      * @see org.ofbiz.base.container.Container#stop()
Index: framework/webtools/webapp/webtools/WEB-INF/actions/service/AvailableServices.groovy
===================================================================
--- framework/webtools/webapp/webtools/WEB-INF/actions/service/AvailableServices.groovy	(revision 1494668)
+++ framework/webtools/webapp/webtools/WEB-INF/actions/service/AvailableServices.groovy	(working copy)
@@ -29,8 +29,8 @@
 import org.ofbiz.base.util.UtilHttp;
 import org.ofbiz.base.util.UtilProperties;
 
-List getEcaListForService(String selectedService) {
-    ecaMap = org.ofbiz.service.eca.ServiceEcaUtil.getServiceEventMap(selectedService);
+List getEcaListForService(String selectedService, delegator) {
+    ecaMap = org.ofbiz.service.eca.ServiceEcaUtil.getServiceEventMap(selectedService, delegator);
 
     if (!ecaMap) return null;
 
@@ -363,7 +363,7 @@
         maxRetry = curServiceModel.maxRetry;
 
         //Test for ECA's
-        ecaMapList = getEcaListForService(selectedService);
+        ecaMapList = getEcaListForService(selectedService, delegator);
         if (ecaMapList) {
             context.ecaMapList = ecaMapList;
         }
Index: framework/webtools/src/org/ofbiz/webtools/artifactinfo/ServiceArtifactInfo.java
===================================================================
--- framework/webtools/src/org/ofbiz/webtools/artifactinfo/ServiceArtifactInfo.java	(revision 1494668)
+++ framework/webtools/src/org/ofbiz/webtools/artifactinfo/ServiceArtifactInfo.java	(working copy)
@@ -39,6 +39,7 @@
 import org.ofbiz.base.util.UtilJavaParse;
 import org.ofbiz.base.util.UtilMisc;
 import org.ofbiz.base.util.UtilPlist;
+import org.ofbiz.entity.Delegator;
 import org.ofbiz.minilang.MiniLangException;
 import org.ofbiz.minilang.SimpleMethod;
 import org.ofbiz.service.ModelParam;
@@ -72,10 +73,10 @@
      *
      * @throws GeneralException
      */
-    public void populateAll() throws GeneralException {
+    public void populateAll(Delegator delegator) throws GeneralException {
         this.populateUsedEntities();
-        this.populateCalledServices();
-        this.populateTriggeredServiceEcas();
+        this.populateCalledServices(delegator);
+        this.populateTriggeredServiceEcas(delegator);
     }
 
     protected void populateUsedEntities() throws GeneralException {
@@ -138,7 +139,7 @@
         }
     }
 
-    protected void populateCalledServices() throws GeneralException {
+    protected void populateCalledServices(Delegator delegator) throws GeneralException {
         // populate servicesCalledByThisService and for each the reverse-associate cache in the aif
         if ("simple".equals(this.modelService.engineName)) {
             // we can do something with this!
@@ -180,7 +181,7 @@
             Set<String> allServiceNameSet = FastSet.newInstance();
             GroupModel groupModel = modelService.internalGroup;
             if (groupModel == null) {
-                groupModel = ServiceGroupReader.getGroupModel(this.modelService.location);
+                groupModel = ServiceGroupReader.getGroupModel(this.modelService.location, delegator);
             }
 
             if (groupModel != null) {
@@ -211,9 +212,9 @@
         }
     }
 
-    protected void populateTriggeredServiceEcas() throws GeneralException {
+    protected void populateTriggeredServiceEcas(Delegator delegator) throws GeneralException {
         // populate serviceEcasTriggeredByThisService and for each the reverse-associate cache in the aif
-        Map<String, List<ServiceEcaRule>> serviceEventMap = ServiceEcaUtil.getServiceEventMap(this.modelService.name);
+        Map<String, List<ServiceEcaRule>> serviceEventMap = ServiceEcaUtil.getServiceEventMap(this.modelService.name, delegator);
         if (serviceEventMap == null) return;
         for (List<ServiceEcaRule> ecaRuleList: serviceEventMap.values()) {
             for (ServiceEcaRule ecaRule: ecaRuleList) {
Index: framework/webtools/src/org/ofbiz/webtools/artifactinfo/ArtifactInfoFactory.java
===================================================================
--- framework/webtools/src/org/ofbiz/webtools/artifactinfo/ArtifactInfoFactory.java	(revision 1494668)
+++ framework/webtools/src/org/ofbiz/webtools/artifactinfo/ArtifactInfoFactory.java	(working copy)
@@ -216,7 +216,7 @@
         if (curInfo == null) {
             curInfo = new ServiceArtifactInfo(serviceName, this);
             this.allServiceInfos.put(serviceName, curInfo);
-            curInfo.populateAll();
+            curInfo.populateAll(this.dispatchContext.getDelegator());
         }
         return curInfo;
     }
Index: framework/service/src/org/ofbiz/service/ModelServiceReader.java
===================================================================
--- framework/service/src/org/ofbiz/service/ModelServiceReader.java	(revision 1494668)
+++ framework/service/src/org/ofbiz/service/ModelServiceReader.java	(working copy)
@@ -74,12 +74,12 @@
         }
 
         ModelServiceReader reader = new ModelServiceReader(true, readerURL, null, dctx);
-        return reader.getModelServices();
+        return reader.getModelServices(dctx.getDelegator());
     }
 
     public static Map<String, ModelService> getModelServiceMap(ResourceHandler handler, DispatchContext dctx) {
         ModelServiceReader reader = new ModelServiceReader(false, null, handler, dctx);
-        return reader.getModelServices();
+        return reader.getModelServices(dctx.getDelegator());
     }
 
     private ModelServiceReader(boolean isFromURL, URL readerURL, ResourceHandler handler, DispatchContext dctx) {
@@ -89,7 +89,7 @@
         this.dctx = dctx;
     }
 
-    private Map<String, ModelService> getModelServices() {
+    private Map<String, ModelService> getModelServices(Delegator delegator) {
         UtilTimer utilTimer = new UtilTimer();
         Document document;
         if (this.isFromURL) {
@@ -186,7 +186,7 @@
         } else {
             utilTimer.timerString("Finished document in " + handler + " - Total Services: " + i + " FINISHED");
             if (Debug.importantOn()) {
-                Debug.logImportant("Loaded [" + StringUtil.leftPad(Integer.toString(i), 3) + "] Services from " + resourceLocation, module);
+                Debug.logImportant("Loaded [" + delegator.getDelegatorName() + "] [" + StringUtil.leftPad(Integer.toString(i), 3) + "] Services from " + resourceLocation, module);
             }
         }
         return modelServices;
Index: framework/service/src/org/ofbiz/service/ServiceDispatcher.java
===================================================================
--- framework/service/src/org/ofbiz/service/ServiceDispatcher.java	(revision 1494668)
+++ framework/service/src/org/ofbiz/service/ServiceDispatcher.java	(working copy)
@@ -88,8 +88,8 @@
     protected ServiceDispatcher(Delegator delegator, boolean enableJM, boolean enableJMS, boolean enableSvcs) {
         Debug.logInfo("[ServiceDispatcher] : Creating new instance.", module);
         factory = new GenericEngineFactory(this);
-        ServiceGroupReader.readConfig();
-        ServiceEcaUtil.readConfig();
+        ServiceGroupReader.readConfig(delegator);
+        ServiceEcaUtil.readConfig(delegator);
 
         this.delegator = delegator;
         this.localContext = FastMap.newInstance();
@@ -278,7 +278,7 @@
             rs = this.logService(localName, modelService, GenericEngine.SYNC_MODE);
 
             // get eventMap once for all calls for speed, don't do event calls if it is null
-            eventMap = ServiceEcaUtil.getServiceEventMap(modelService.name);
+            eventMap = ServiceEcaUtil.getServiceEventMap(modelService.name, ctx.getDelegator());
             engine = this.getGenericEngine(modelService.engineName);
 
 
@@ -668,7 +668,7 @@
 
             try {
                 // get eventMap once for all calls for speed, don't do event calls if it is null
-                Map<String, List<ServiceEcaRule>> eventMap = ServiceEcaUtil.getServiceEventMap(service.name);
+                Map<String, List<ServiceEcaRule>> eventMap = ServiceEcaUtil.getServiceEventMap(service.name, ctx.getDelegator());
 
                 // pre-auth ECA
                 if (eventMap != null) ServiceEcaUtil.evalRules(service.name, eventMap, "auth", ctx, context, result, isError, isFailure);
Index: framework/service/src/org/ofbiz/service/ModelService.java
===================================================================
--- framework/service/src/org/ofbiz/service/ModelService.java	(revision 1494668)
+++ framework/service/src/org/ofbiz/service/ModelService.java	(working copy)
@@ -1101,7 +1101,7 @@
             if (this.engineName.equals("group") && implServices.size() == 0) {
                 GroupModel group = internalGroup;
                 if (group == null) {
-                    group = ServiceGroupReader.getGroupModel(this.location);
+                    group = ServiceGroupReader.getGroupModel(this.location, dctx.getDelegator());
                 }
                 if (group != null) {
                     for (GroupServiceModel sm: group.getServices()) {
Index: framework/service/src/org/ofbiz/service/DispatchContext.java
===================================================================
--- framework/service/src/org/ofbiz/service/DispatchContext.java	(revision 1494668)
+++ framework/service/src/org/ofbiz/service/DispatchContext.java	(working copy)
@@ -19,6 +19,8 @@
 package org.ofbiz.service;
 
 import java.io.Serializable;
+import java.util.Collection;
+import java.util.LinkedList;
 import java.util.List;
 import java.util.Map;
 import java.util.Set;
@@ -32,15 +34,21 @@
 import javolution.util.FastMap;
 
 import org.ofbiz.base.component.ComponentConfig;
+import org.ofbiz.base.component.ComponentConfig.ServiceResourceInfo;
 import org.ofbiz.base.concurrent.ExecutionPool;
 import org.ofbiz.base.config.GenericConfigException;
 import org.ofbiz.base.config.MainResourceHandler;
 import org.ofbiz.base.config.ResourceHandler;
 import org.ofbiz.base.util.Debug;
+import org.ofbiz.base.util.UtilMisc;
+import org.ofbiz.base.util.UtilValidate;
 import org.ofbiz.base.util.cache.UtilCache;
 import org.ofbiz.entity.Delegator;
+import org.ofbiz.entity.GenericEntityException;
+import org.ofbiz.entity.GenericValue;
 import org.ofbiz.entity.GenericEntityConfException;
 import org.ofbiz.entity.config.EntityConfigUtil;
+import org.ofbiz.entity.util.EntityUtil;
 import org.ofbiz.entity.config.model.DelegatorElement;
 import org.ofbiz.security.Security;
 import org.ofbiz.service.config.ServiceConfigUtil;
@@ -56,13 +64,14 @@
 
     public static final String module = DispatchContext.class.getName();
 
-    private static final UtilCache<String, Map<String, ModelService>> modelServiceMapByModel = UtilCache.createUtilCache("service.ModelServiceMapByModel", 0, 0, false);
+    public static UtilCache<String, UtilCache<String, Map<String, ModelService>>> tenantModelServiceMapByModel = UtilCache.createUtilCache("service.ModelServiceMapByDispatcher", 0, 0, false);
 
     // these four fields represent the immutable state of a DispatchContext object
     private final String name;
     private final transient ClassLoader loader;
     private final transient LocalDispatcher dispatcher;
     private final String model;
+    protected Map<String, Map<String, ModelService>> modelServiceMapByDispatcher = null;
 
     /**
      * Creates new DispatchContext as an immutable object.
@@ -99,7 +108,12 @@
             modelName = name;
         }
         this.model = modelName;
-        getGlobalServiceMap();
+        
+        try {
+            getGlobalServiceMap(getTenantComponentNames());
+        } catch (GenericServiceException e) {
+            Debug.logError(e, module);
+        }
     }
 
     /**
@@ -205,7 +219,7 @@
      * @return GenericServiceModel that corresponds to the serviceName
      */
     public ModelService getModelService(String serviceName) throws GenericServiceException {
-        Map<String, ModelService> serviceMap = getGlobalServiceMap();
+        Map<String, ModelService> serviceMap = getGlobalServiceMap(getTenantComponentNames());
         ModelService retVal = null;
         if (serviceMap != null) {
             retVal = serviceMap.get(serviceName);
@@ -222,6 +236,7 @@
     public Set<String> getAllServiceNames() {
         Set<String> serviceNames = new TreeSet<String>();
 
+        UtilCache<String, Map<String, ModelService>> modelServiceMapByModel = tenantModelServiceMapByModel.get(this.dispatcher.getDelegator().getDelegatorName());
         Map<String, ModelService> globalServices = modelServiceMapByModel.get(this.model);
         if (globalServices != null) {
             serviceNames.addAll(globalServices.keySet());
@@ -242,7 +257,12 @@
         };
     }
 
-    private Map<String, ModelService> getGlobalServiceMap() {
+    private Map<String, ModelService> getGlobalServiceMap(List<String> componentNames) {
+        UtilCache<String, Map<String, ModelService>> modelServiceMapByModel = tenantModelServiceMapByModel.get(this.dispatcher.getDelegator().getDelegatorName());
+        if (UtilValidate.isEmpty(modelServiceMapByModel)) {
+            modelServiceMapByModel = UtilCache.createUtilCache("service.ModelServiceMapByModel." + this.dispatcher.getDelegator().getDelegatorName(), 0, 0, false);
+            tenantModelServiceMapByModel.put(this.dispatcher.getDelegator().getDelegatorName(), modelServiceMapByModel);
+        }
         Map<String, ModelService> serviceMap = modelServiceMapByModel.get(this.model);
         if (serviceMap == null) {
             serviceMap = FastMap.newInstance();
@@ -261,8 +281,16 @@
                 futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createServiceReaderCallable(handler)));
             }
 
-            // get all of the component resource model stuff, ie specified in each ofbiz-component.xml file
-            for (ComponentConfig.ServiceResourceInfo componentResourceInfo: ComponentConfig.getAllServiceResourceInfos("model")) {
+            // get service resource infos
+            List<ServiceResourceInfo> serviceResourceInfos = new LinkedList<ServiceResourceInfo>();
+            Collection<ComponentConfig> components = ComponentConfig.getTenantComponents(componentNames);
+            for (ComponentConfig component : components) {
+                List<ServiceResourceInfo> componentServiceResourceInfos = ComponentConfig.getAllServiceResourceInfos("model", component.getComponentName());
+                serviceResourceInfos.addAll(componentServiceResourceInfos);
+            }
+            
+            // create resource handler
+            for (ComponentConfig.ServiceResourceInfo componentResourceInfo: serviceResourceInfos) {
                 futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createServiceReaderCallable(componentResourceInfo.createResourceHandler())));
             }
             for (Map<String, ModelService> servicesMap: ExecutionPool.getAllFutures(futures)) {
@@ -274,10 +302,28 @@
             if (serviceMap != null) {
                 Map<String, ModelService> cachedServiceMap = modelServiceMapByModel.putIfAbsentAndGet(this.model, serviceMap);
                 if (cachedServiceMap == serviceMap) { // same object: this means that the object created by this thread was actually added to the cache
-                    ServiceEcaUtil.reloadConfig();
+                    ServiceEcaUtil.reloadConfig(this.dispatcher.getDelegator());
                 }
             }
         }
         return serviceMap;
     }
+    
+    private List<String> getTenantComponentNames() throws GenericServiceException {
+        List<String> componentNames = null;
+        Delegator delegator = getDelegator();
+        String tenantId = delegator.getDelegatorTenantId();
+        if (UtilValidate.isNotEmpty(tenantId)) {
+            // get tenant components
+            try {
+                List<GenericValue> tenantComponents = delegator.findByAnd("TenantComponent", UtilMisc.toMap("tenantId", tenantId), UtilMisc.toList("sequenceNum"), false);
+                componentNames = EntityUtil.getFieldListFromEntityList(tenantComponents, "componentName", true);
+            } catch (GenericEntityException e) {
+                throw new GenericServiceException(e);
+            }
+        } else {
+            componentNames = ComponentConfig.getDefaultHotDeployComponentNames();
+        }
+        return componentNames;
+    }
 }
Index: framework/service/src/org/ofbiz/service/eca/ServiceEcaUtil.java
===================================================================
--- framework/service/src/org/ofbiz/service/eca/ServiceEcaUtil.java	(revision 1494668)
+++ framework/service/src/org/ofbiz/service/eca/ServiceEcaUtil.java	(working copy)
@@ -19,6 +19,7 @@
 package org.ofbiz.service.eca;
 
 import java.util.Collection;
+import java.util.LinkedHashMap;
 import java.util.List;
 import java.util.Map;
 import java.util.Set;
@@ -35,8 +36,13 @@
 import org.ofbiz.base.config.MainResourceHandler;
 import org.ofbiz.base.config.ResourceHandler;
 import org.ofbiz.base.util.Debug;
+import org.ofbiz.base.util.UtilMisc;
 import org.ofbiz.base.util.UtilValidate;
 import org.ofbiz.base.util.UtilXml;
+import org.ofbiz.entity.Delegator;
+import org.ofbiz.entity.GenericEntityException;
+import org.ofbiz.entity.GenericValue;
+import org.ofbiz.entity.util.EntityUtil;
 import org.ofbiz.service.DispatchContext;
 import org.ofbiz.service.GenericServiceException;
 import org.ofbiz.service.config.ServiceConfigUtil;
@@ -53,14 +59,21 @@
     public static final String module = ServiceEcaUtil.class.getName();
 
     // using a cache is dangerous here because if someone clears it the ECAs won't run: public static UtilCache ecaCache = new UtilCache("service.ServiceECAs", 0, 0, false);
-    public static Map<String, Map<String, List<ServiceEcaRule>>> ecaCache = FastMap.newInstance();
+    public static Map<String, Map<String, Map<String, List<ServiceEcaRule>>>> tenantEcaCache = new LinkedHashMap<String, Map<String,Map<String,List<ServiceEcaRule>>>>();
 
-    public static void reloadConfig() {
+    public static void reloadConfig(Delegator delegator) {
+        Map<String, Map<String, List<ServiceEcaRule>>> ecaCache = tenantEcaCache.get(delegator.getDelegatorName());
         ecaCache.clear();
-        readConfig();
+        readConfig(delegator);
     }
 
-    public static void readConfig() {
+    public static void readConfig(Delegator delegator) {
+        Map<String, Map<String, List<ServiceEcaRule>>> ecaCache = tenantEcaCache.get(delegator.getDelegatorName());
+        if (UtilValidate.isEmpty(ecaCache)) {
+            ecaCache = new LinkedHashMap<String, Map<String,List<ServiceEcaRule>>>();
+            tenantEcaCache.put(delegator.getDelegatorName(), ecaCache);
+        }
+        
         // Only proceed if the cache hasn't already been populated, caller should be using reloadConfig() in that situation
         if (UtilValidate.isNotEmpty(ecaCache)) {
             return;
@@ -77,33 +90,47 @@
         }
         for (ServiceEcas serviceEcas : serviceEcasList) {
             ResourceHandler handler = new MainResourceHandler(ServiceConfigUtil.SERVICE_ENGINE_XML_FILENAME, serviceEcas.getLoader(), serviceEcas.getLocation());
-            futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(handler)));
+            futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(handler, delegator)));
         }
 
         // get all of the component resource eca stuff, ie specified in each ofbiz-component.xml file
-        for (ComponentConfig.ServiceResourceInfo componentResourceInfo: ComponentConfig.getAllServiceResourceInfos("eca")) {
-            futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(componentResourceInfo.createResourceHandler())));
+        try {
+            Collection<ComponentConfig> components = null;
+            if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId())) {
+                List<GenericValue> tenantComponents = delegator.findByAnd("TenantComponent", UtilMisc.toMap("tenantId", delegator.getDelegatorTenantId()), null, false);
+                List<String> componentNames = EntityUtil.getFieldListFromEntityList(tenantComponents, "componentName", true);
+                components = ComponentConfig.getTenantComponents(componentNames);
+            } else {
+                components = ComponentConfig.getDefaultTenantComponents();
+            }
+            for (ComponentConfig component : components) {
+                for (ComponentConfig.ServiceResourceInfo componentResourceInfo: ComponentConfig.getAllServiceResourceInfos("eca", component.getComponentName())) {
+                    futures.add(ExecutionPool.GLOBAL_EXECUTOR.submit(createEcaLoaderCallable(componentResourceInfo.createResourceHandler(), delegator)));
+                }
+            }
+        } catch (GenericEntityException e) {
+            Debug.logError(e, module);
         }
 
         for (List<ServiceEcaRule> handlerRules: ExecutionPool.getAllFutures(futures)) {
-            mergeEcaDefinitions(handlerRules);
+            mergeEcaDefinitions(handlerRules, delegator);
         }
     }
 
-    protected static Callable<List<ServiceEcaRule>> createEcaLoaderCallable(final ResourceHandler handler) {
+    protected static Callable<List<ServiceEcaRule>> createEcaLoaderCallable(final ResourceHandler handler, final Delegator delegator) {
         return new Callable<List<ServiceEcaRule>>() {
             public List<ServiceEcaRule> call() throws Exception {
-                return getEcaDefinitions(handler);
+                return getEcaDefinitions(handler, delegator);
             }
         };
     }
 
-    public static void addEcaDefinitions(ResourceHandler handler) {
-        List<ServiceEcaRule> handlerRules = getEcaDefinitions(handler);
-        mergeEcaDefinitions(handlerRules);
+    public static void addEcaDefinitions(ResourceHandler handler, Delegator delegator) {
+        List<ServiceEcaRule> handlerRules = getEcaDefinitions(handler, delegator);
+        mergeEcaDefinitions(handlerRules, delegator);
     }
 
-    private static List<ServiceEcaRule> getEcaDefinitions(ResourceHandler handler) {
+    private static List<ServiceEcaRule> getEcaDefinitions(ResourceHandler handler, Delegator delegator) {
         List<ServiceEcaRule> handlerRules = FastList.newInstance();
         Element rootElement = null;
         try {
@@ -128,7 +155,8 @@
         return handlerRules;
     }
 
-    private static void mergeEcaDefinitions(List<ServiceEcaRule> handlerRules) {
+    private static void mergeEcaDefinitions(List<ServiceEcaRule> handlerRules, Delegator delegator) {
+        Map<String, Map<String, List<ServiceEcaRule>>> ecaCache = tenantEcaCache.get(delegator.getDelegatorName());
         for (ServiceEcaRule rule: handlerRules) {
             String serviceName = rule.getServiceName();
             String eventName = rule.getEventName();
@@ -151,13 +179,18 @@
         }
     }
 
-    public static Map<String, List<ServiceEcaRule>> getServiceEventMap(String serviceName) {
-        if (ServiceEcaUtil.ecaCache == null) ServiceEcaUtil.readConfig();
-        return ServiceEcaUtil.ecaCache.get(serviceName);
+    public static Map<String, List<ServiceEcaRule>> getServiceEventMap(String serviceName, Delegator delegator) {
+        Map<String, Map<String, List<ServiceEcaRule>>> ecaCache = tenantEcaCache.get(delegator.getDelegatorName());
+        if (UtilValidate.isEmpty(ecaCache)) {
+            ServiceEcaUtil.readConfig(delegator);
+            tenantEcaCache.put(delegator.getDelegatorName(), ecaCache);
+        }
+        
+        return ecaCache.get(serviceName);
     }
 
-    public static List<ServiceEcaRule> getServiceEventRules(String serviceName, String event) {
-        Map<String, List<ServiceEcaRule>> eventMap = getServiceEventMap(serviceName);
+    public static List<ServiceEcaRule> getServiceEventRules(String serviceName, String event, Delegator delegator) {
+        Map<String, List<ServiceEcaRule>> eventMap = getServiceEventMap(serviceName, delegator);
         if (eventMap != null) {
             if (event != null) {
                 return eventMap.get(event);
@@ -174,7 +207,7 @@
 
     public static void evalRules(String serviceName, Map<String, List<ServiceEcaRule>> eventMap, String event, DispatchContext dctx, Map<String, Object> context, Map<String, Object> result, boolean isError, boolean isFailure) throws GenericServiceException {
         // if the eventMap is passed we save a Map lookup, but if not that's okay we'll just look it up now
-        if (eventMap == null) eventMap = getServiceEventMap(serviceName);
+        if (eventMap == null) eventMap = getServiceEventMap(serviceName, dctx.getDelegator());
         if (UtilValidate.isEmpty(eventMap)) {
             return;
         }
@@ -190,4 +223,8 @@
             eca.eval(serviceName, dctx, context, result, isError, isFailure, actionsRun);
         }
     }
+    
+    public static Map<String, Map<String, List<ServiceEcaRule>>> getEcaCache(Delegator delegator) {
+        return tenantEcaCache.get(delegator.getDelegatorName());
+    }
 }
Index: framework/service/src/org/ofbiz/service/group/ServiceGroupReader.java
===================================================================
--- framework/service/src/org/ofbiz/service/group/ServiceGroupReader.java	(revision 1494668)
+++ framework/service/src/org/ofbiz/service/group/ServiceGroupReader.java	(working copy)
@@ -18,17 +18,24 @@
  *******************************************************************************/
 package org.ofbiz.service.group;
 
+import java.util.Collection;
+import java.util.LinkedHashMap;
 import java.util.List;
 import java.util.Map;
 
-import javolution.util.FastMap;
 
 import org.ofbiz.base.component.ComponentConfig;
 import org.ofbiz.base.config.GenericConfigException;
 import org.ofbiz.base.config.MainResourceHandler;
 import org.ofbiz.base.config.ResourceHandler;
 import org.ofbiz.base.util.Debug;
+import org.ofbiz.base.util.UtilMisc;
+import org.ofbiz.base.util.UtilValidate;
 import org.ofbiz.base.util.UtilXml;
+import org.ofbiz.entity.Delegator;
+import org.ofbiz.entity.GenericEntityException;
+import org.ofbiz.entity.GenericValue;
+import org.ofbiz.entity.util.EntityUtil;
 import org.ofbiz.service.config.ServiceConfigUtil;
 import org.ofbiz.service.config.model.ServiceGroups;
 import org.w3c.dom.Element;
@@ -43,9 +50,22 @@
     public static final String module = ServiceGroupReader.class.getName();
 
     // using a cache is dangerous here because if someone clears it the groups won't work at all: public static UtilCache groupsCache = new UtilCache("service.ServiceGroups", 0, 0, false);
-    public static Map<String, GroupModel> groupsCache = FastMap.newInstance();
+    public static Map<String, Map<String, GroupModel>> tenantGroupsCache = new LinkedHashMap<String, Map<String,GroupModel>>();
 
-    public static void readConfig() {
+    public static void readConfig(Delegator delegator) {
+        String delegatorName = null;
+        if (UtilValidate.isNotEmpty(delegator)) {
+            delegatorName = delegator.getDelegatorName();
+        } else {
+            delegatorName = "default";
+        }
+        
+        Map<String, GroupModel> groupsCache = tenantGroupsCache.get(delegator.getDelegatorName());
+        if (UtilValidate.isEmpty(groupsCache)) {
+            groupsCache = new LinkedHashMap<String, GroupModel>();
+            tenantGroupsCache.put(delegatorName, groupsCache);
+        }
+        
         List<ServiceGroups> serviceGroupsList = null;
         try {
             serviceGroupsList = ServiceConfigUtil.getServiceEngine().getServiceGroups();
@@ -56,16 +76,31 @@
         }
         for (ServiceGroups serviceGroup : serviceGroupsList) {
             ResourceHandler handler = new MainResourceHandler(ServiceConfigUtil.SERVICE_ENGINE_XML_FILENAME, serviceGroup.getLoader(), serviceGroup.getLocation());
-            addGroupDefinitions(handler);
+            addGroupDefinitions(handler, delegator);
         }
-
-        // get all of the component resource group stuff, ie specified in each ofbiz-component.xml file
-        for (ComponentConfig.ServiceResourceInfo componentResourceInfo: ComponentConfig.getAllServiceResourceInfos("group")) {
-            addGroupDefinitions(componentResourceInfo.createResourceHandler());
+        
+        try {
+            Collection<ComponentConfig> components = null;
+            if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId())) {
+                List<GenericValue> tenantComponents = delegator.findByAnd("TenantComponent", UtilMisc.toMap("tenantId", delegator.getDelegatorTenantId()), UtilMisc.toList("sequenceNum"), false);
+                List<String> componentNames = EntityUtil.getFieldListFromEntityList(tenantComponents, "componentName", true);
+                components = ComponentConfig.getTenantComponents(componentNames);
+            } else {
+                components = ComponentConfig.getDefaultTenantComponents();
+            }
+            
+            for (ComponentConfig component : components) {
+                for (ComponentConfig.ServiceResourceInfo componentResourceInfo: ComponentConfig.getAllServiceResourceInfos("group", component.getComponentName())) {
+                    addGroupDefinitions(componentResourceInfo.createResourceHandler(), delegator);
+                }
+            }
+        } catch (GenericEntityException e) {
+            Debug.logError(e, module);
         }
     }
 
-    public static void addGroupDefinitions(ResourceHandler handler) {
+    public static void addGroupDefinitions(ResourceHandler handler, Delegator delegator) {
+        Map<String, GroupModel> groupsCache = tenantGroupsCache.get(delegator.getDelegatorName());
         Element rootElement = null;
 
         try {
@@ -88,13 +123,19 @@
             } catch (GenericConfigException e) {
                 Debug.logError(e, "Could not get resource URL", module);
             }
-            Debug.logImportant("Loaded [" + StringUtil.leftPad(Integer.toString(numDefs), 3) + "] Group definitions from " + resourceLocation, module);
-        }
+            Debug.logImportant("Loaded [" + delegator.getDelegatorName() + "] [" + StringUtil.leftPad(Integer.toString(numDefs), 3) + "] Group definitions from " + resourceLocation, module);
+         }
     }
 
-    public static GroupModel getGroupModel(String serviceName) {
+    public static GroupModel getGroupModel(String serviceName, Delegator delegator) {
+        Map<String, GroupModel> groupsCache = tenantGroupsCache.get(delegator.getDelegatorName());
+        if (UtilValidate.isEmpty(groupsCache)) {
+            groupsCache = new LinkedHashMap<String, GroupModel>();
+            tenantGroupsCache.put(delegator.getDelegatorName(), groupsCache);
+        }
+        
         if (groupsCache.size() == 0) {
-            ServiceGroupReader.readConfig();
+            ServiceGroupReader.readConfig(delegator);
         }
         return groupsCache.get(serviceName);
     }
Index: framework/service/src/org/ofbiz/service/group/ServiceGroupEngine.java
===================================================================
--- framework/service/src/org/ofbiz/service/group/ServiceGroupEngine.java	(revision 1494668)
+++ framework/service/src/org/ofbiz/service/group/ServiceGroupEngine.java	(working copy)
@@ -45,7 +45,7 @@
     public Map<String, Object> runSync(String localName, ModelService modelService, Map<String, Object> context) throws GenericServiceException {
         GroupModel groupModel = modelService.internalGroup;
         if (groupModel == null) {
-            groupModel = ServiceGroupReader.getGroupModel(this.getLocation(modelService));
+            groupModel = ServiceGroupReader.getGroupModel(this.getLocation(modelService), dispatcher.getDelegator());
         }
         if (groupModel == null) {
             throw new GenericServiceException("GroupModel was null; not a valid ServiceGroup!");
Index: framework/testtools/src/org/ofbiz/testtools/ModelTestSuite.java
===================================================================
--- framework/testtools/src/org/ofbiz/testtools/ModelTestSuite.java	(revision 1494668)
+++ framework/testtools/src/org/ofbiz/testtools/ModelTestSuite.java	(working copy)
@@ -36,6 +36,7 @@
 import org.ofbiz.entity.Delegator;
 import org.ofbiz.entity.DelegatorFactory;
 import org.ofbiz.entity.testtools.EntityTestCase;
+import org.ofbiz.entity.util.EntityUtilProperties;
 import org.ofbiz.minilang.MiniLangException;
 import org.ofbiz.minilang.SimpleMethod;
 import org.ofbiz.service.LocalDispatcher;
@@ -68,11 +69,29 @@
         this.originalDispatcherName = mainElement.getAttribute("dispatcher-name");
         if (UtilValidate.isEmpty(this.originalDispatcherName)) this.originalDispatcherName = "test-dispatcher";
 
-        String uniqueSuffix = "-" + RandomStringUtils.randomAlphanumeric(10);
+        Delegator originalDelegator = DelegatorFactory.getDelegator(this.originalDelegatorName);
+        String useMultitenant = EntityUtilProperties.getPropertyValue("general.properties", "multitenant", originalDelegator);
+        if ("Y".equals(useMultitenant) && UtilValidate.isNotEmpty(originalDelegator.getDelegatorTenantId())) {
+            
+            this.delegator = originalDelegator.makeTestDelegator(originalDelegator.getDelegatorName());
+            LocalDispatcher originalDispatcher = ServiceContainer.getLocalDispatcher(this.delegator.getDelegatorName(), this.delegator);
+            this.dispatcher = originalDispatcher;
+            
+            /*
+            ModelReader.readers.put(this.delegator.getDelegatorName(), ModelReader.readers.get(originalDelegator.getDelegatorName()));
+            DispatchContext dispatchContext = this.dispatcher.getDispatchContext();
+            originalDispatcher.getDispatchContext().loadReaders();
+            DispatchContext.tenantModelServiceMapByDispatcher.put(dispatchContext.getName(), DispatchContext.tenantModelServiceMapByDispatcher.get(originalDispatcher.getDispatchContext().getName()));
+            EntityEcaUtil.tenantEntityEcaReaders.put(this.delegator.getDelegatorName(), EntityEcaUtil.tenantEntityEcaReaders.get(originalDelegator.getDelegatorName()));
+            ServiceEcaUtil.tenantEcaCache.put(this.delegator.getDelegatorName(), ServiceEcaUtil.tenantEcaCache.get(originalDelegator.getDelegatorName()));
+            ServiceGroupReader.tenantGroupsCache.put(this.delegator.getDelegatorName(), ServiceGroupReader.tenantGroupsCache.get(originalDelegator.getDelegatorName()));
+            */
+        } else {
+            String uniqueSuffix = "-" + RandomStringUtils.randomAlphanumeric(10);
+            this.delegator = originalDelegator.makeTestDelegator(this.originalDelegatorName + uniqueSuffix);
+            this.dispatcher = ServiceContainer.getLocalDispatcher(originalDispatcherName + uniqueSuffix, delegator);
+        }
 
-        this.delegator = DelegatorFactory.getDelegator(this.originalDelegatorName).makeTestDelegator(this.originalDelegatorName + uniqueSuffix);
-        this.dispatcher = ServiceContainer.getLocalDispatcher(originalDispatcherName + uniqueSuffix, delegator);
-
         for (Element testCaseElement : UtilXml.childElementList(mainElement, UtilMisc.toSet("test-case", "test-group"))) {
             String caseName = testCaseElement.getAttribute("case-name");
             String nodeName = testCaseElement.getNodeName();
Index: framework/testtools/build.xml
===================================================================
--- framework/testtools/build.xml	(revision 1494668)
+++ framework/testtools/build.xml	(working copy)
@@ -37,6 +37,7 @@
         <fileset dir="../base/build/lib" includes="*.jar"/>
         <fileset dir="../entity/lib" includes="*.jar"/>
         <fileset dir="../entity/build/lib" includes="*.jar"/>
+        <fileset dir="../entityext/build/lib" includes="*.jar"/>
         <fileset dir="../security/build/lib" includes="*.jar"/>
         <fileset dir="../service/lib" includes="*.jar"/>
         <fileset dir="../service/build/lib" includes="*.jar"/>
Index: framework/images/webapp/images/WEB-INF/web.xml
===================================================================
--- framework/images/webapp/images/WEB-INF/web.xml	(revision 1494668)
+++ framework/images/webapp/images/WEB-INF/web.xml	(working copy)
@@ -22,6 +22,33 @@
 <web-app>
   <display-name>Open For Business - demostore images</display-name>
   <description>Demo Store Images for the Open For Business Project</description>
+    <context-param>
+        <param-name>localDispatcherName</param-name>
+        <param-value>images</param-value>
+        <description>A unique name used to identify/recognize the local dispatcher for the Service Engine</description>
+    </context-param>
+    <filter>
+        <filter-name>ContextFilter</filter-name>
+        <display-name>ContextFilter</display-name>
+        <filter-class>org.ofbiz.webapp.control.ContextFilter</filter-class>
+        <init-param>
+            <param-name>allowedPaths</param-name>
+            <param-value>/products</param-value>
+        </init-param>
+    </filter>
+    <filter>
+        <filter-name>TenantImageFilter</filter-name>
+        <display-name>TenantImageFilter</display-name>
+        <filter-class>org.ofbiz.tenant.control.TenantImageFilter</filter-class>
+    </filter>
+    <filter-mapping>
+        <filter-name>ContextFilter</filter-name>
+        <url-pattern>/products/*</url-pattern>
+    </filter-mapping>
+    <filter-mapping>
+        <filter-name>TenantImageFilter</filter-name>
+        <url-pattern>/products/*</url-pattern>
+    </filter-mapping>
 
   <session-config>
     <session-timeout>1</session-timeout>
Index: specialpurpose/ecommerce/widget/CommonScreens.xml
===================================================================
--- specialpurpose/ecommerce/widget/CommonScreens.xml	(revision 1494668)
+++ specialpurpose/ecommerce/widget/CommonScreens.xml	(working copy)
@@ -73,6 +73,7 @@
                   <widgets>
                      <platform-specific><html><html-template location="component://ecommerce/webapp/ecommerce/includes/headerHead.ftl"/></html></platform-specific>
                      <platform-specific><html><html-template location="component://common/webcommon/includes/openhtmlbody.ftl"/></html></platform-specific>
+                     <include-screen name="demoAnnounceMessage" location="component://ofbizdemo/widget/CommonScreens.xml"/>
                      <!-- render header -->
                      <container id="header"><platform-specific><html><html-template location="${headerTemplateLocation}"/></html></platform-specific></container>
 
Index: specialpurpose/ecommerce/ofbiz-component.xml
===================================================================
--- specialpurpose/ecommerce/ofbiz-component.xml	(revision 1494668)
+++ specialpurpose/ecommerce/ofbiz-component.xml	(working copy)
@@ -68,5 +68,11 @@
         location="webapp/ecomclone"
         mount-point="/ecomclone"
         app-bar-display="false"/>
+    <webapp name="demoecommerce"
+        title="Demo eCommerce"
+        server="default-server"
+        location="webapp/ecommerce"
+        mount-point="/"
+        app-bar-display="false"/>
 </ofbiz-component>
 
Index: themes/bizznesstime/includes/header.ftl
===================================================================
--- themes/bizznesstime/includes/header.ftl	(revision 1494668)
+++ themes/bizznesstime/includes/header.ftl	(working copy)
@@ -114,6 +114,7 @@
 </#if>
 <#assign organizationLogoLinkURL = "${layoutSettings.organizationLogoLinkUrl?if_exists}">
 <body>
+  ${screens.render("component://ofbizdemo/widget/CommonScreens.xml#demoAnnounceMessage")}
 <div id="wrap">
   <div id="wait-spinner" style="display:none">
     <div id="wait-spinner-image"></div>
Index: themes/tomahawk/includes/header.ftl
===================================================================
--- themes/tomahawk/includes/header.ftl	(revision 1494668)
+++ themes/tomahawk/includes/header.ftl	(working copy)
@@ -96,6 +96,7 @@
 <#assign organizationLogoLinkURL = "${layoutSettings.organizationLogoLinkUrl?if_exists}">
 
 <body>
+  ${screens.render("component://ofbizdemo/widget/CommonScreens.xml#demoAnnounceMessage")}
   <div id="wait-spinner" style="display:none">
     <div id="wait-spinner-image"></div>
   </div>
Index: themes/flatgrey/includes/header.ftl
===================================================================
--- themes/flatgrey/includes/header.ftl	(revision 1494668)
+++ themes/flatgrey/includes/header.ftl	(working copy)
@@ -92,6 +92,7 @@
 </#if>
 <#assign organizationLogoLinkURL = "${layoutSettings.organizationLogoLinkUrl?if_exists}">
 <body>
+  ${screens.render("component://ofbizdemo/widget/CommonScreens.xml#demoAnnounceMessage")}
   <div id="wait-spinner" style="display:none">
     <div id="wait-spinner-image"></div>
   </div>
Index: applications/order/webapp/ordermgr/order/orderReportContactMechs.fo.ftl
===================================================================
--- applications/order/webapp/ordermgr/order/orderReportContactMechs.fo.ftl	(revision 1494668)
+++ applications/order/webapp/ordermgr/order/orderReportContactMechs.fo.ftl	(working copy)
@@ -31,7 +31,7 @@
                 <#if postalAddress.address2?has_content><fo:block>${postalAddress.address2?if_exists}</fo:block></#if>
                 <fo:block>
                     <#assign stateGeo = (delegator.findOne("Geo", {"geoId", postalAddress.stateProvinceGeoId?if_exists}, false))?if_exists />
-                    ${postalAddress.city}<#if stateGeo?has_content>, ${stateGeo.geoName?if_exists}</#if> ${postalAddress.postalCode?if_exists}
+                    ${postalAddress.city} ${postalAddress.postalCode?if_exists}
                 </fo:block>
                 <fo:block>
                     <#assign countryGeo = (delegator.findOne("Geo", {"geoId", postalAddress.countryGeoId?if_exists}, false))?if_exists />
@@ -63,7 +63,7 @@
                 <#if postalAddress.address2?has_content><fo:block>${postalAddress.address2?if_exists}</fo:block></#if>
                 <fo:block>
                     <#assign stateGeo = (delegator.findOne("Geo", {"geoId", postalAddress.stateProvinceGeoId?if_exists}, false))?if_exists />
-                    ${postalAddress.city}<#if stateGeo?has_content>, ${stateGeo.geoName?if_exists}</#if> ${postalAddress.postalCode?if_exists}
+                    ${postalAddress.city} ${postalAddress.postalCode?if_exists}
                 </fo:block>
                 <fo:block>
                     <#assign countryGeo = (delegator.findOne("Geo", {"geoId", postalAddress.countryGeoId?if_exists}, false))?if_exists />
Index: applications/party/webapp/partymgr/WEB-INF/controller.xml
===================================================================
--- applications/party/webapp/partymgr/WEB-INF/controller.xml	(revision 1494668)
+++ applications/party/webapp/partymgr/WEB-INF/controller.xml	(working copy)
@@ -1246,6 +1246,17 @@
         <security https="true" auth="true"/>
         <response name="success" type="view" value="ProfileEditUserLoginSecurityGroups"/>
     </request-map>
+    
+    <request-map uri="approvalseller">
+        <security https="true" auth="true"/>
+        <response name="success" type="view" value="approvalseller"/>
+    </request-map>
+    <request-map uri="approveShopmaxSeller">
+        <security https="true" auth="true"/>
+        <event type="service" path="" invoke="approveShopmaxSeller"/>
+        <response name="success" type="view" value="approvalseller"/>
+        <response name="error" type="view" value="approvalseller"/>
+    </request-map>
 
     <!-- end of request mappings -->
 
@@ -1376,5 +1387,7 @@
     <!-- GeoLocation-->
     <view-map name="addGeoLocation" type="screen" page="component://party/widget/partymgr/PartyScreens.xml#EditGeoLocation"/>
 
+    <view-map name="approvalseller" type="screen" page="component://shopmax/widget/ShopMaxScreens.xml#ApprovalSeller"/>
+
     <!-- end of view mappings -->
 </site-conf>
Index: applications/party/widget/partymgr/PartyMenus.xml
===================================================================
--- applications/party/widget/partymgr/PartyMenus.xml	(revision 1494668)
+++ applications/party/widget/partymgr/PartyMenus.xml	(working copy)
@@ -35,6 +35,7 @@
         </menu-item>
         <menu-item name="addrmap" title="${uiLabelMap.PageTitleAddressMatchMap}"><link target="addressMatchMap"/></menu-item>
         <menu-item name="partyinv" title="${uiLabelMap.PartyInvitation}"><link target="partyInvitation"/></menu-item>
+        <menu-item name="approvalseller" title="Approval Seller"><link target="approvalseller"/></menu-item>
     </menu>
 
     <menu name="ProfileTabBar" extends="CommonTabBarMenu" extends-resource="component://common/widget/CommonMenus.xml"
Index: applications/product/webapp/catalog/category/EditCategory.ftl
===================================================================
--- applications/product/webapp/catalog/category/EditCategory.ftl	(revision 1494668)
+++ applications/product/webapp/catalog/category/EditCategory.ftl	(working copy)
@@ -194,6 +194,17 @@
                     </td>
                 </tr>
                 <tr>
+                    <td width="26%" align="right" class="label">Show In Flyout</td>
+                    <td>&nbsp;</td>
+                    <td width="74%">
+                        <select name="showInFlyout" size="1">
+                            <#if productCategory?has_content><option>${productCategory.showInFlyout?if_exists}</option></#if>
+                            <option value="N">N</option>
+                            <option value="Y">Y</option>
+                        </select>
+                    </td>
+                </tr>
+                <tr>
                     <td colspan="2">&nbsp;</td>
                     <td><input type="submit" name="Update" value="${uiLabelMap.CommonUpdate}"/></td>
                 </tr>
Index: applications/product/webapp/catalog/WEB-INF/actions/imagemanagement/ImageUpload.groovy
===================================================================
--- applications/product/webapp/catalog/WEB-INF/actions/imagemanagement/ImageUpload.groovy	(revision 1494668)
+++ applications/product/webapp/catalog/WEB-INF/actions/imagemanagement/ImageUpload.groovy	(working copy)
@@ -27,8 +27,13 @@
 
 // make the image file formats
 imageFilenameFormat = UtilProperties.getPropertyValue('catalog', 'image.filename.format');
-imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
 imageUrlPrefix = UtilProperties.getPropertyValue('catalog', 'image.url.prefix');
+imageServerPath = null;
+if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId())) {
+    imageServerPath = System.getProperty("ofbiz.home") + File.separatorChar + "runtime" + File.separatorChar + "tenants" + File.separatorChar + delegator.getDelegatorTenantId() + File.separatorChar + "images";
+} else {
+    imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+}
 context.imageFilenameFormat = imageFilenameFormat;
 context.imageServerPath = imageServerPath;
 context.imageUrlPrefix = imageUrlPrefix;
@@ -126,7 +131,7 @@
 
             // call scaleImageInAllSize
             if (fileType.equals("original")) {
-                result = ScaleImage.scaleImageInAllSize(context, filenameToUse, "main", "0");
+                result = ScaleImage.scaleImageInAllSize(context, imageServerPath, filenameToUse, "main", "0");
 
                 if (result.containsKey("responseMessage") && result.get("responseMessage").equals("success")) {
                     imgMap = result.get("imageUrlMap");
Index: applications/product/webapp/catalog/WEB-INF/actions/imagemanagement/SetDefaultImage.groovy
===================================================================
--- applications/product/webapp/catalog/WEB-INF/actions/imagemanagement/SetDefaultImage.groovy	(revision 1494668)
+++ applications/product/webapp/catalog/WEB-INF/actions/imagemanagement/SetDefaultImage.groovy	(working copy)
@@ -44,8 +44,13 @@
 
 // make the image file formats
 imageFilenameFormat = UtilProperties.getPropertyValue('catalog', 'image.filename.format');
-imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
 imageUrlPrefix = UtilProperties.getPropertyValue('catalog', 'image.url.prefix');
+imageServerPath = null;
+if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId())) {
+    imageServerPath = System.getProperty("ofbiz.home") + File.separatorChar + "runtime" + File.separatorChar + "tenants" + File.separatorChar + delegator.getDelegatorTenantId() + File.separatorChar + "images";
+} else {
+    imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+}
 context.imageFilenameFormat = imageFilenameFormat;
 context.imageServerPath = imageServerPath;
 context.imageUrlPrefix = imageUrlPrefix;
@@ -164,7 +169,7 @@
 
             // call scaleImageInAllSize
             if (fileType.equals("original")) {
-                result = ScaleImage.scaleImageInAllSize(context, filenameToUse, "main", "0");
+                result = ScaleImage.scaleImageInAllSize(context, imageServerPath, filenameToUse, "main", "0");
 
                 if (result.containsKey("responseMessage") && result.get("responseMessage").equals("success")) {
                     imgMap = result.get("imageUrlMap");
Index: applications/product/webapp/catalog/WEB-INF/actions/product/EditProductContent.groovy
===================================================================
--- applications/product/webapp/catalog/WEB-INF/actions/product/EditProductContent.groovy	(revision 1494668)
+++ applications/product/webapp/catalog/WEB-INF/actions/product/EditProductContent.groovy	(working copy)
@@ -26,8 +26,13 @@
 
 // make the image file formats
 imageFilenameFormat = UtilProperties.getPropertyValue('catalog', 'image.filename.format');
-imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
 imageUrlPrefix = UtilProperties.getPropertyValue('catalog', 'image.url.prefix');
+imageServerPath = null;
+if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId())) {
+    imageServerPath = System.getProperty("ofbiz.home") + File.separatorChar + "runtime" + File.separatorChar + "tenants" + File.separatorChar + delegator.getDelegatorTenantId() + File.separatorChar + "images";
+} else {
+    imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+}
 context.imageFilenameFormat = imageFilenameFormat;
 context.imageServerPath = imageServerPath;
 context.imageUrlPrefix = imageUrlPrefix;
@@ -143,7 +148,7 @@
 
             // call scaleImageInAllSize
             if (fileType.equals("original")) {
-                result = ScaleImage.scaleImageInAllSize(context, filenameToUse, "main", "0");
+                result = ScaleImage.scaleImageInAllSize(context, imageServerPath, filenameToUse, "main", "0");
 
                 if (result.containsKey("responseMessage") && result.get("responseMessage").equals("success")) {
                     imgMap = result.get("imageUrlMap");
Index: applications/product/webapp/catalog/WEB-INF/controller.xml
===================================================================
--- applications/product/webapp/catalog/WEB-INF/controller.xml	(revision 1494668)
+++ applications/product/webapp/catalog/WEB-INF/controller.xml	(working copy)
@@ -3072,6 +3072,44 @@
         <response name="success" type="request-redirect" value="EditProductTag"/>
         <response name="error" type="view" value="EditProductTag"/>
     </request-map>
+
+    <request-map uri="EditProductCategoryFlyoutSub">
+        <security https="true" auth="true"/>
+        <response name="success" type="view" value="EditProductCategoryFlyoutSub"/>
+    </request-map>
+    
+    <request-map uri="createProductCategoryFlyoutSub">
+        <security https="true" auth="true"/>
+        <event type="service" invoke="createProductCategoryFlyoutSub"/>
+        <response name="success" type="view" value="EditProductCategoryFlyoutSub"/>
+        <response name="error" type="view" value="EditProductCategoryFlyoutSub"/>
+    </request-map>
+    
+    <request-map uri="deleteProductCategoryFlyoutSub">
+        <security https="true" auth="true"/>
+        <event type="service" invoke="deleteProductCategoryFlyoutSub"/>
+        <response name="success" type="view" value="EditProductCategoryFlyoutSub"/>
+        <response name="error" type="view" value="EditProductCategoryFlyoutSub"/>
+    </request-map>
+    
+    <request-map uri="EditProductCategoryRelated">
+        <security https="true" auth="true"/>
+        <response name="success" type="view" value="EditProductCategoryRelated"/>
+    </request-map>
+    
+    <request-map uri="createProductCategoryRelated">
+        <security https="true" auth="true"/>
+        <event type="service" invoke="createProductCategoryRelated"/>
+        <response name="success" type="view" value="EditProductCategoryRelated"/>
+        <response name="error" type="view" value="EditProductCategoryRelated"/>
+    </request-map>
+    
+    <request-map uri="deleteProductCategoryRelated">
+        <security https="true" auth="true"/>
+        <event type="service" invoke="deleteProductCategoryRelated"/>
+        <response name="success" type="view" value="EditProductCategoryRelated"/>
+        <response name="error" type="view" value="EditProductCategoryRelated"/>
+    </request-map>
     <!-- end of request mappings -->
 
     <!-- View Mappings -->
@@ -3287,4 +3325,7 @@
     <view-map name="LookupImageFrame" type="screen" page="component://product/widget/catalog/ImageManagementScreens.xml#LookupImageFrame"/>
     <view-map name="ImageResize" type="screen" page="component://product/widget/catalog/ImageManagementScreens.xml#ImageResize"/>
     <!-- end of view mappings -->
+    
+    <view-map name="EditProductCategoryFlyoutSub" type="screen" page="component://shopmax/widget/CatalogScreens.xml#EditProductCategoryFlyoutSub"/>
+    <view-map name="EditProductCategoryRelated" type="screen" page="component://shopmax/widget/CatalogScreens.xml#EditProductCategoryRelated"/>
 </site-conf>
Index: applications/product/servicedef/services.xml
===================================================================
--- applications/product/servicedef/services.xml	(revision 1494668)
+++ applications/product/servicedef/services.xml	(working copy)
@@ -840,9 +840,9 @@
     <service name="safeAddProductCategoryToCategory" engine="simple"
                 location="component://product/script/org/ofbiz/product/category/CategoryServices.xml" invoke="addProductCategoryToCategory" auth="true">
         <description>Safe Add ProductCategory To Category (requires fromDate)</description>
-        <attribute name="productCategoryId" type="String" mode="IN" optional="false"/>
-        <attribute name="parentProductCategoryId" type="String" mode="IN" optional="false"/>
-        <attribute name="fromDate" type="Timestamp" mode="IN" optional="false"/>
+        <attribute name="productCategoryId" type="String" mode="INOUT" optional="false"/>
+        <attribute name="parentProductCategoryId" type="String" mode="INOUT" optional="false"/>
+        <attribute name="fromDate" type="Timestamp" mode="INOUT" optional="false"/>
         <attribute name="thruDate" type="Timestamp" mode="IN" optional="true"/>
         <attribute name="sequenceNum" type="Long" mode="IN" optional="true"/>
     </service>
@@ -869,8 +869,8 @@
                 location="component://product/script/org/ofbiz/product/category/CategoryServices.xml" invoke="updateProductCategoryToCategory" auth="true">
         <description>Update ProductCategory To Category</description>
         <attribute name="productCategoryId" type="String" mode="INOUT" optional="false"/>
-        <attribute name="parentProductCategoryId" type="String" mode="IN" optional="false"/>
-        <attribute name="fromDate" type="Timestamp" mode="IN" optional="false"/>
+        <attribute name="parentProductCategoryId" type="String" mode="INOUT" optional="false"/>
+        <attribute name="fromDate" type="Timestamp" mode="INOUT" optional="false"/>
         <attribute name="thruDate" type="Timestamp" mode="IN" optional="true"/>
         <attribute name="sequenceNum" type="Long" mode="IN" optional="true"/>
     </service>
Index: applications/product/widget/catalog/CatalogMenus.xml
===================================================================
--- applications/product/widget/catalog/CatalogMenus.xml	(revision 1494668)
+++ applications/product/widget/catalog/CatalogMenus.xml	(working copy)
@@ -145,6 +145,16 @@
                 <parameter param-name="productCategoryId"/>
             </link>
         </menu-item>
+        <menu-item name="EditProductCategoryFlyoutSub" title="Flyout Subcategory">
+            <link target="EditProductCategoryFlyoutSub">
+                <parameter param-name="productCategoryId"/>
+            </link>
+        </menu-item>
+        <menu-item name="EditProductCategoryRelated" title="Related">
+            <link target="EditProductCategoryRelated">
+                <parameter param-name="productCategoryId"/>
+            </link>
+        </menu-item>
     </menu>
 
     <menu name="CategorySubTabBar" menu-container-style="button-bar button-style-2" default-selected-style="selected">
Index: applications/product/script/org/ofbiz/product/category/CategoryServices.xml
===================================================================
--- applications/product/script/org/ofbiz/product/category/CategoryServices.xml	(revision 1494668)
+++ applications/product/script/org/ofbiz/product/category/CategoryServices.xml	(working copy)
@@ -277,6 +277,9 @@
         </if-empty>
 
         <create-value value-field="newEntity"/>
+        <field-to-result field="newEntity.productCategoryId" result-name="productCategoryId"/>
+        <field-to-result field="newEntity.parentProductCategoryId" result-name="parentProductCategoryId"/>
+        <field-to-result field="newEntity.fromDate" result-name="fromDate"/>
     </simple-method>
     <simple-method method-name="addProductCategoryToCategories" short-description="Add ProductCategory to Categories">
         <if-instance-of field="parameters.categories" class="java.util.List">
@@ -334,6 +337,8 @@
         <set-nonpk-fields map="parameters" value-field="lookedUpValue"/>
         <store-value value-field="lookedUpValue"/>
         <field-to-result field="parameters.productCategoryId" result-name="productCategoryId"/>
+        <field-to-result field="parameters.parentProductCategoryId" result-name="parentProductCategoryId"/>
+        <field-to-result field="parameters.fromDate" result-name="fromDate"/>
     </simple-method>
     <simple-method method-name="removeProductCategoryFromCategory" short-description="Remove ProductCategory From Category">
         <set value="removeProductCategoryFromCategory" field="callingMethodName"/>
Index: applications/product/script/org/ofbiz/product/product/ProductServices.xml
===================================================================
--- applications/product/script/org/ofbiz/product/product/ProductServices.xml	(revision 1494668)
+++ applications/product/script/org/ofbiz/product/product/ProductServices.xml	(working copy)
@@ -33,6 +33,13 @@
         <set from-field="parameters.productId" field="newEntity.productId"/>
         <if-empty field="newEntity.productId">
             <sequenced-id sequence-name="Product" field="newEntity.productId"/>
+            <entity-and entity-name="PartyRole" list="partyRoles">
+                <field-map field-name="roleTypeId" value="SELLER"/>
+            </entity-and>
+            <if-not-empty field="partyRoles">
+                <first-from-list entry="partyRole" list="partyRoles"/>
+                <set field="newEntity.productId" value="${partyRole.partyId}-${newEntity.productId}"/>
+            </if-not-empty>
         <else>
             <check-id field="newEntity.productId"/>
             <check-errors />
Index: applications/product/config/catalog.properties
===================================================================
--- applications/product/config/catalog.properties	(revision 1494668)
+++ applications/product/config/catalog.properties	(working copy)
@@ -36,8 +36,8 @@
 reactivate.product.from.receipt=Y
 
 # Image upload path on the image management
-image.management.path=${sys:getProperty('ofbiz.home')}/framework/images/webapp/images/products/management
-image.management.url=/images/products/management
+image.management.path=${sys:getProperty('ofbiz.home')}/hot-deploy/shopmax/webapp/shopmax-product/images/products
+image.management.url=/shopmax-product/images/products
 image.management.nameofthumbnail=-100
 image.management.autoApproveImage=Y
 image.management.multipleApproval=N
Index: applications/product/src/org/ofbiz/product/imagemanagement/ImageManagementServices.java
===================================================================
--- applications/product/src/org/ofbiz/product/imagemanagement/ImageManagementServices.java	(revision 1494668)
+++ applications/product/src/org/ofbiz/product/imagemanagement/ImageManagementServices.java	(working copy)
@@ -93,6 +93,7 @@
         String uploadFileName = (String) context.get("_uploadedFile_fileName");
         String imageResize = (String) context.get("imageResize");
         Locale locale = (Locale) context.get("locale");
+        Long sequenceNum = (Long) context.get("sequenceNum");
         
         if (UtilValidate.isNotEmpty(uploadFileName)) {
             String imageFilenameFormat = UtilProperties.getPropertyValue("catalog", "image.filename.format");
@@ -258,6 +259,7 @@
             productContentCtx.put("userLogin", userLogin);
             productContentCtx.put("contentId", contentId);
             productContentCtx.put("statusId", "IM_PENDING");
+            productContentCtx.put("sequenceNum", sequenceNum);
             try {
                 dispatcher.runSync("createProductContent", productContentCtx);
             } catch (GenericServiceException e) {
Index: applications/product/src/org/ofbiz/product/product/ProductServices.java
===================================================================
--- applications/product/src/org/ofbiz/product/product/ProductServices.java	(revision 1494668)
+++ applications/product/src/org/ofbiz/product/product/ProductServices.java	(working copy)
@@ -983,8 +983,13 @@
 
         if (UtilValidate.isNotEmpty(context.get("_uploadedFile_fileName"))) {
             String imageFilenameFormat = UtilProperties.getPropertyValue("catalog", "image.filename.additionalviewsize.format");
-            String imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
             String imageUrlPrefix = UtilProperties.getPropertyValue("catalog", "image.url.prefix");
+            String imageServerPath = null;
+            if (UtilValidate.isNotEmpty(delegator.getDelegatorTenantId())) {
+                imageServerPath = System.getProperty("ofbiz.home") + File.separatorChar + "runtime" + File.separatorChar + "tenants" + File.separatorChar + delegator.getDelegatorTenantId() + File.separatorChar + "images";
+            } else {
+                imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+            }
 
             FlexibleStringExpander filenameExpander = FlexibleStringExpander.getInstance(imageFilenameFormat);
             String viewNumber = String.valueOf(productContentTypeId.charAt(productContentTypeId.length() - 1));
@@ -1075,7 +1080,7 @@
             /* scale Image in different sizes */
             Map<String, Object> resultResize = FastMap.newInstance();
             try {
-                resultResize.putAll(ScaleImage.scaleImageInAllSize(context, filenameToUse, "additional", viewNumber));
+                resultResize.putAll(ScaleImage.scaleImageInAllSize(context, imageServerPath, filenameToUse, "additional", viewNumber));
             } catch (IOException e) {
                 Debug.logError(e, "Scale additional image in all different sizes is impossible : " + e.toString(), module);
                 return ServiceUtil.returnError(UtilProperties.getMessage(resource, 
Index: applications/product/src/org/ofbiz/product/image/ScaleImage.java
===================================================================
--- applications/product/src/org/ofbiz/product/image/ScaleImage.java	(revision 1494668)
+++ applications/product/src/org/ofbiz/product/image/ScaleImage.java	(working copy)
@@ -71,7 +71,7 @@
      * @throws  IOException                 Error prevents the document from being fully parsed
      * @throws  JDOMException               Errors occur in parsing
      */
-    public static Map<String, Object> scaleImageInAllSize(Map<String, ? extends Object> context, String filenameToUse, String viewType, String viewNumber)
+    public static Map<String, Object> scaleImageInAllSize(Map<String, ? extends Object> context, String imageServerPath, String filenameToUse, String viewType, String viewNumber)
         throws IllegalArgumentException, ImagingOpException, IOException, JDOMException {
 
         /* VARIABLES */
@@ -104,7 +104,9 @@
         index = filenameToUse.lastIndexOf(".");
         String imgExtension = filenameToUse.substring(index + 1);
         // paths
-        String imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+        if (UtilValidate.isEmpty(imageServerPath)) {
+            imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+        }
         String imageUrlPrefix = UtilProperties.getPropertyValue("catalog", "image.url.prefix");
         
         FlexibleStringExpander filenameExpander;
@@ -240,7 +242,7 @@
         }
     }
 
-    public static Map<String, Object> scaleImageManageInAllSize(Map<String, ? extends Object> context, String filenameToUse, String viewType, String viewNumber , String imageType)
+    public static Map<String, Object> scaleImageManageInAllSize(Map<String, ? extends Object> context, String imageServerPath, String filenameToUse, String viewType, String viewNumber , String imageType)
         throws IllegalArgumentException, ImagingOpException, IOException, JDOMException {
 
         /* VARIABLES */
@@ -281,7 +283,9 @@
         String imgExtension = filenameToUse.substring(index + 1);
         // paths
         String mainFilenameFormat = UtilProperties.getPropertyValue("catalog", "image.filename.format");
-        String imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+        if (UtilValidate.isEmpty(imageServerPath)) {
+            imageServerPath = FlexibleStringExpander.expandString(UtilProperties.getPropertyValue("catalog", "image.server.path"), context);
+        }
         String imageUrlPrefix = UtilProperties.getPropertyValue("catalog", "image.url.prefix");
 
         String id = null;
Index: applications/content/servicedef/secas.xml
===================================================================
--- applications/content/servicedef/secas.xml	(revision 1494668)
+++ applications/content/servicedef/secas.xml	(working copy)
@@ -123,6 +123,7 @@
         <set field-name="roleTypeId" value="OWNER"/>
         <action service="createContentRole" mode="sync" run-as-user="system"/>
     </eca>
+    <!--
     <eca service="createContent" event="commit">
         <condition field-name="partyId" operator="is-empty"/>
         <condition field-name="roleTypeId" operator="is-empty"/>
@@ -131,7 +132,7 @@
         <set field-name="roleTypeId" value="OWNER"/>
         <action service="createContentRole" mode="sync" run-as-user="system"/>
     </eca>
-
+    -->
     <eca service="createContent" event="commit">
         <condition field-name="contentAssocTypeId" operator="is-not-empty"/>
         <condition field-name="contentIdTo" operator="is-not-empty"/>
